<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kartu Kontrol PBJT</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@4.2.0/fonts/remixicon.css" rel="stylesheet">
    <style>
        body { font-family: system-ui, -apple-system, sans-serif; }
        .hidden { display: none !important; }
        .modal { transition: opacity 0.2s; }
        .modal-content { transition: transform 0.2s; transform: translateY(100%); }
        .modal:not(.hidden) .modal-content { transform: translateY(0); }
        .signature-canvas { touch-action: none; }
        .online-badge { animation: pulse 2s infinite; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">

    <!-- Login Page -->
    <div id="login-page" class="min-h-screen flex items-center justify-center p-4 bg-gradient-to-br from-blue-600 to-blue-800">
        <div class="bg-white rounded-2xl p-8 w-full max-w-sm shadow-2xl">
            <div class="text-center mb-6">
                <div class="w-20 h-20 bg-gradient-to-br from-blue-500 to-blue-700 rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg">
                    <i class="ri-clipboard-text-line text-white text-4xl"></i>
                </div>
                <h1 class="text-2xl font-bold text-gray-800">Kartu Kontrol PBJT</h1>
                <p class="text-gray-500 text-sm mt-1">Sistem Pemungutan Pajak Restoran</p>
            </div>
            <form id="login-form" class="space-y-4">
                <div class="relative">
                    <i class="ri-user-line absolute left-4 top-3.5 text-gray-400"></i>
                    <input type="text" id="login-username" placeholder="Username / NIP" required class="w-full pl-12 pr-4 py-3 border rounded-xl focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <div class="relative">
                    <i class="ri-lock-line absolute left-4 top-3.5 text-gray-400"></i>
                    <input type="password" id="login-password" placeholder="Password" required class="w-full pl-12 pr-4 py-3 border rounded-xl focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <button type="submit" class="w-full bg-gradient-to-r from-blue-600 to-blue-700 text-white py-3 rounded-xl font-medium hover:shadow-lg transition">Masuk</button>
            </form>
            <div class="mt-6 text-center">
                <a href="#" onclick="showResetPasswordModal()" class="text-blue-600 text-sm hover:underline">Lupa Password?</a>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="app-container" class="hidden max-w-lg mx-auto pb-24">
        
        <!-- Header -->
        <div class="bg-white shadow-sm px-4 py-3 sticky top-0 z-40">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="font-bold text-xl text-gray-800" id="page-title">Dashboard</h1>
                    <p class="text-xs text-gray-500" id="current-date"></p>
                    <p class="text-xs text-blue-600 font-medium" id="user-role"></p>
                </div>
                <button onclick="logout()" class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center text-gray-600 hover:bg-red-100 hover:text-red-500 transition">
                    <i class="ri-logout-box-line text-xl"></i>
                </button>
            </div>
        </div>

        <!-- Online Status -->
        <div id="online-status" class="m-4 px-4 py-3 rounded-lg flex items-center gap-3 hidden">
            <span id="sync-icon" class="text-xl"></span>
            <div class="flex-1">
                <p class="font-medium" id="sync-status-text">-</p>
                <p class="text-xs text-gray-500" id="sync-detail-text">-</p>
            </div>
        </div>

        <!-- Content -->
        <div class="p-4">
            
            <!-- Dashboard -->
            <div id="section-dashboard" class="section">
                
                <!-- Petugas Info -->
                <div class="bg-gradient-to-r from-blue-500 to-blue-600 rounded-xl p-4 mb-4 text-white shadow-lg">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center">
                            <i class="ri-user-line text-2xl"></i>
                        </div>
                        <div class="flex-1">
                            <p class="text-xs text-blue-100">Petugas Aktif</p>
                            <p class="font-bold text-lg" id="active-petugas-nama">-</p>
                            <p class="text-sm text-blue-100">NIP: <span id="active-petugas-nip">-</span></p>
                        </div>
                        <button id="btn-change-petugas" onclick="openPetugasModal()" class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center hover:bg-white/30 transition">
                            <i class="ri-edit-line"></i>
                        </button>
                    </div>
                </div>

                <!-- Stats -->
                <div class="grid grid-cols-2 gap-3 mb-4">
                    <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100">
                        <div class="flex items-center gap-2 mb-2">
                            <div class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center">
                                <i class="ri-calendar-check-line text-blue-600"></i>
                            </div>
                            <p class="text-xs text-gray-500">Hari Ini</p>
                        </div>
                        <p class="text-2xl font-bold text-gray-800" id="stat-hari-ini">0</p>
                        <p class="text-xs text-gray-400">objek</p>
                    </div>
                    <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100">
                        <div class="flex items-center gap-2 mb-2">
                            <div class="w-8 h-8 bg-green-100 rounded-lg flex items-center justify-center">
                                <i class="ri-money-dollar-circle-line text-green-600"></i>
                            </div>
                            <p class="text-xs text-gray-500">Pajak Hari</p>
                        </div>
                        <p class="text-xl font-bold text-green-600" id="stat-pajak-hari">Rp 0</p>
                    </div>
                    <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100">
                        <div class="flex items-center gap-2 mb-2">
                            <div class="w-8 h-8 bg-purple-100 rounded-lg flex items-center justify-center">
                                <i class="ri-pie-chart-line text-purple-600"></i>
                            </div>
                            <p class="text-xs text-gray-500">Bulan Ini</p>
                        </div>
                        <p class="text-xl font-bold text-purple-600" id="stat-bulan">Rp 0</p>
                    </div>
                    <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100">
                        <div class="flex items-center gap-2 mb-2">
                            <div class="w-8 h-8 bg-red-100 rounded-lg flex items-center justify-center">
                                <i class="ri-alert-line text-red-600"></i>
                            </div>
                            <p class="text-xs text-gray-500">Tunggakan</p>
                        </div>
                        <p class="text-xl font-bold text-red-600" id="stat-tunggakan">Rp 0</p>
                    </div>
                </div>

                <!-- Chart -->
                <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100 mb-4">
                    <p class="font-medium text-gray-700 mb-3">Grafik 7 Hari Terakhir</p>
                    <div class="flex items-end justify-between gap-1 h-24" id="chart-container"></div>
                </div>

                <!-- Today Data -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                    <div class="px-4 py-3 border-b border-gray-100 font-medium text-gray-700 flex justify-between items-center">
                        <span>Pemungutan Hari Ini</span>
                        <span class="text-xs text-gray-400" id="today-count">0 data</span>
                    </div>
                    <div id="today-list" class="divide-y divide-gray-50">
                        <p class="text-gray-400 text-center py-8 text-sm">Belum ada data</p>
                    </div>
                </div>
            </div>

            <!-- Kartu Kontrol -->
            <div id="section-kartu" class="section hidden">
                <!-- Admin: Riwayat Semua Kartu -->
                <div id="kartu-riwayat-section" class="hidden mb-4">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="font-bold text-gray-800">Riwayat Semua Kartu Kontrol</h3>
                        <select id="filter-riwayat" class="px-3 py-2 border rounded-lg text-sm" onchange="loadRiwayatKartu()">
                            <option value="semua">Semua Waktu</option>
                            <option value="bulan-ini" selected>Bulan Ini</option>
                            <option value="bulan-lalu">Bulan Lalu</option>
                        </select>
                    </div>
                    <div id="riwayat-list" class="space-y-3 max-h-[60vh] overflow-y-auto"></div>
                </div>

                <!-- Detail Kartu (Single Date View) -->
                <div id="kartu-tanggal-section">
                    <div class="flex gap-2 mb-4">
                        <input type="date" id="filter-tanggal" class="flex-1 px-4 py-3 border rounded-xl focus:ring-2 focus:ring-blue-500 outline-none" onchange="loadKartuKontrol()">
                        <button onclick="console.log('=== Buat Baru button clicked ==='); createNewKartu();" class="bg-blue-600 text-white px-4 py-3 rounded-xl font-medium hover:bg-blue-700 transition">
                            <i class="ri-add-line mr-1"></i>Buat Baru
                        </button>
                    </div>

                    <div id="kartu-info" class="bg-gradient-to-r from-blue-500 to-blue-600 rounded-xl p-4 mb-4 text-white hidden">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-xs text-blue-100">No. Kartu</p>
                                <p class="font-bold text-lg" id="info-no-kartu">-</p>
                                <p class="text-sm text-blue-100 mt-1">Petugas: <span id="info-petugas">-</span></p>
                                <p class="text-sm text-blue-100 mt-1">Jam: <span id="info-jam">-</span></p>
                            </div>
                            <div class="text-right">
                                <p class="text-xs text-blue-100">Total Objek</p>
                                <p class="font-bold text-lg" id="info-objek">0</p>
                                <p class="text-sm text-blue-100 mt-1"><span id="info-lunas">0</span> Lunas / <span id="info-tunggakan">0</span> Tunggakan</p>
                            </div>
                        </div>
                    </div>

                    <button onclick="showDetailKartu(currentKartuId)" id="btn-detail-kartu" class="w-full mb-4 bg-purple-600 text-white py-3 rounded-xl font-medium hover:bg-purple-700 transition hidden flex items-center justify-center gap-2">
                        <i class="ri-eye-line"></i> Lihat Detail Kartu
                    </button>

                    <div id="kartu-list" class="space-y-3"></div>

                    <div id="kartu-actions" class="mt-4 hidden">
                        <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100 mb-4">
                            <label class="text-sm block mb-2 text-gray-600">Jam Selesai</label>
                            <input type="time" id="jam-selesai" class="w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-blue-500 outline-none" onchange="saveJamSelesai()">
                        </div>
                        <button onclick="printKartu()" class="w-full bg-gradient-to-r from-green-600 to-green-700 text-white py-3 rounded-xl font-medium shadow-lg hover:shadow-xl transition">
                            <i class="ri-printer-line mr-2"></i>Cetak Kartu Kontrol
                        </button>
                    </div>
                </div>
            </div>

            <!-- Tunggakan -->
            <div id="section-tunggakan" class="section hidden">
                <div class="flex gap-2 mb-4">
                    <select id="filter-status-tunggakan" class="px-4 py-2 border rounded-xl" onchange="loadTunggakan()">
                        <option value="">Semua Status</option>
                        <option value="Belum Lunas">Belum Lunas</option>
                        <option value="Janji Bayar">Janji Bayar</option>
                    </select>
                </div>
                <div id="tunggakan-list" class="space-y-3"></div>
            </div>

            <!-- Wajib Pajak -->
            <div id="section-wp" class="section hidden">
                <div class="flex gap-2 mb-4">
                    <div class="relative flex-1">
                        <i class="ri-search-line absolute left-3 top-3 text-gray-400"></i>
                        <input type="text" id="search-wp" placeholder="Cari wajib pajak..." class="w-full pl-10 pr-4 py-3 border rounded-xl focus:ring-2 focus:ring-blue-500 outline-none" onkeyup="renderWP()">
                    </div>
                    <button onclick="openWPModal()" class="bg-blue-600 text-white px-4 py-3 rounded-xl font-medium hover:bg-blue-700 transition">
                        <i class="ri-add-line"></i>
                    </button>
                </div>
                <div id="wp-list" class="space-y-3"></div>
            </div>

            <!-- Pengaturan -->
            <div id="section-setting" class="section hidden">
                <div class="space-y-4">
                    
                    <!-- Firebase Settings -->
                    <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100">
                        <div class="flex items-center gap-2 mb-3">
                            <i class="ri-cloud-line text-blue-600"></i>
                            <div class="font-medium">Penyimpanan Online (Firebase)</div>
                        </div>
                        <div id="firebase-status" class="mb-3 px-3 py-2 rounded-lg text-sm bg-gray-100 text-gray-600">
                            üîµ Belum diatur
                        </div>
                        <div class="space-y-2 mb-3">
                            <input type="text" id="firebase-api-key" placeholder="Firebase API Key" class="w-full px-3 py-2 border rounded-lg text-sm">
                            <input type="text" id="firebase-project-id" placeholder="Firebase Project ID" class="w-full px-3 py-2 border rounded-lg text-sm">
                            <input type="text" id="firebase-database-url" placeholder="Firebase Database URL" class="w-full px-3 py-2 border rounded-lg text-sm">
                        </div>
                        
                        <div class="border-t border-gray-200 pt-3 mb-3">
                            <p class="text-sm font-medium text-gray-700 mb-2">Pengaturan Sinkronisasi</p>
                            
                            <div class="flex items-center justify-between py-2">
                                <span class="text-sm text-gray-600">Sinkronisasi Otomatis</span>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="auto-sync-toggle" class="sr-only peer" onchange="toggleAutoSync()">
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                </label>
                            </div>
                            
                            <div class="flex items-center justify-between py-2">
                                <span class="text-sm text-gray-600">Sinkron Saat Online</span>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="sync-on-online-toggle" class="sr-only peer" onchange="toggleSyncOnOnline()">
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                </label>
                            </div>
                            
                            <div id="last-sync-container" class="mt-2 hidden">
                                <p class="text-xs text-gray-500">Sinkronisasi terakhir:</p>
                                <p id="last-sync-time" class="text-sm text-blue-600 font-medium">-</p>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-3 gap-2 mb-2">
                            <button onclick="saveFirebaseConfig()" class="bg-blue-600 text-white py-2 rounded-lg text-sm">Simpan</button>
                            <button onclick="testConnection()" class="bg-gray-200 text-gray-700 py-2 rounded-lg text-sm">Test</button>
                            <button onclick="manualSync()" class="bg-green-600 text-white py-2 rounded-lg text-sm">Sync</button>
                        </div>
                        <button onclick="clearFirebaseConfig()" class="w-full bg-red-100 text-red-600 py-2 rounded-lg text-sm">Hapus Config</button>
                    </div>

                    <!-- Ganti Password -->
                    <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100">
                        <div class="flex items-center gap-2 mb-3">
                            <i class="ri-lock-line text-blue-600"></i>
                            <div class="font-medium">Ganti Password</div>
                        </div>
                        <form id="form-password" class="space-y-3">
                            <input type="password" id="old-pass" placeholder="Password lama" class="w-full px-4 py-2 border rounded-lg">
                            <input type="password" id="new-pass" placeholder="Password baru" class="w-full px-4 py-2 border rounded-lg">
                            <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-lg">Ganti Password</button>
                        </form>
                    </div>

                    <!-- Petugas -->
                    <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100">
                        <div class="flex justify-between items-center mb-3">
                            <div class="flex items-center gap-2">
                                <i class="ri-user-star-line text-blue-600"></i>
                                <div class="font-medium">Data Petugas</div>
                            </div>
                            <button onclick="openPetugasModal()" class="text-blue-600 text-sm font-medium">Tambah</button>
                        </div>
                        <div id="petugas-list"></div>
                    </div>

                    <!-- Pengaturan Umum -->
                    <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100">
                        <div class="flex items-center gap-2 mb-3">
                            <i class="ri-settings-3-line text-blue-600"></i>
                            <div class="font-medium">Pengaturan Umum</div>
                        </div>
                        <div class="space-y-3">
                            <div>
                                <label class="text-sm block mb-1 text-gray-600">Nama Daerah</label>
                                <input type="text" id="setting-daerah" class="w-full px-4 py-2 border rounded-lg" placeholder="Contoh: Bandung">
                            </div>
                            <div>
                                <label class="text-sm block mb-1 text-gray-600">Nama Dinas</label>
                                <input type="text" id="setting-dinas" class="w-full px-4 py-2 border rounded-lg" value="Dinas Pendapatan Daerah">
                            </div>
                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <label class="text-sm block mb-1 text-gray-600">Tarif Makanan %</label>
                                    <input type="number" id="setting-tarif-m" class="w-full px-4 py-2 border rounded-lg" value="10">
                                </div>
                                <div>
                                    <label class="text-sm block mb-1 text-gray-600">Tarif Minuman %</label>
                                    <input type="number" id="setting-tarif-n" class="w-full px-4 py-2 border rounded-lg" value="10">
                                </div>
                            </div>
                            <button onclick="saveSettings()" class="w-full bg-green-600 text-white py-2 rounded-lg">Simpan Pengaturan</button>
                        </div>
                    </div>

                    <!-- Pejabat TTD -->
                    <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100">
                        <div class="flex items-center gap-2 mb-3">
                            <i class="ri-file-text-line text-blue-600"></i>
                            <div class="font-medium">Pejabat Penandatangan</div>
                        </div>
                        <div class="space-y-3">
                            <div>
                                <label class="text-sm block mb-1 text-gray-600">Mengetahui</label>
                                <input type="text" id="pejabat1" class="w-full px-4 py-2 border rounded-lg mb-1" placeholder="Nama">
                                <input type="text" id="nip1" class="w-full px-4 py-2 border rounded-lg" placeholder="NIP">
                            </div>
                            <div>
                                <label class="text-sm block mb-1 text-gray-600">Menyetujui</label>
                                <input type="text" id="pejabat2" class="w-full px-4 py-2 border rounded-lg mb-1" placeholder="Nama">
                                <input type="text" id="nip2" class="w-full px-4 py-2 border rounded-lg" placeholder="NIP">
                            </div>
                        </div>
                    </div>

                    <!-- Export/Import -->
                    <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100">
                        <div class="flex items-center gap-2 mb-3">
                            <i class="ri-database-line text-blue-600"></i>
                            <div class="font-medium">Data</div>
                        </div>
                        <div class="grid grid-cols-2 gap-2 mb-2">
                            <button onclick="exportToExcel()" class="bg-green-100 text-green-700 py-2 rounded-lg font-medium flex items-center justify-center gap-2 text-sm">
                                <i class="ri-file-excel-2-line"></i> Export Excel
                            </button>
                            <button onclick="exportData()" class="bg-blue-100 text-blue-700 py-2 rounded-lg font-medium flex items-center justify-center gap-2 text-sm">
                                <i class="ri-file-text-line"></i> Export JSON
                            </button>
                        </div>
                        <label class="w-full bg-purple-100 text-purple-700 py-2 rounded-lg text-center cursor-pointer font-medium flex items-center justify-center gap-2 text-sm">
                            <i class="ri-upload-2-line"></i> Import JSON <input type="file" accept=".json" class="hidden" onchange="importData(event)">
                        </label>
                        <button onclick="resetData()" class="w-full mt-2 bg-red-100 text-red-700 py-2 rounded-lg text-sm">Reset Semua Data</button>
                    </div>
                </div>
            </div>

        </div>

        <!-- Bottom Nav -->
        <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 shadow-lg">
            <div class="flex justify-around py-2 safe-area-bottom">
                <button onclick="showSection('dashboard')" class="flex-1 flex flex-col items-center py-2 text-blue-600 nav-btn active" data-section="dashboard">
                    <i class="ri-home-line text-xl"></i>
                    <span class="text-xs mt-1">Beranda</span>
                </button>
                <button onclick="showSection('kartu')" class="flex-1 flex flex-col items-center py-2 text-gray-400 nav-btn" data-section="kartu">
                    <i class="ri-clipboard-line text-xl"></i>
                    <span class="text-xs mt-1">Kartu</span>
                </button>
                <button onclick="showSection('tunggakan')" class="flex-1 flex flex-col items-center py-2 text-gray-400 nav-btn" data-section="tunggakan">
                    <div class="relative">
                        <i class="ri-alert-line text-xl"></i>
                        <span id="tunggakan-badge" class="absolute -top-1 -right-2 w-4 h-4 bg-red-500 text-white text-xs rounded-full hidden">0</span>
                    </div>
                    <span class="text-xs mt-1">Tunggakan</span>
                </button>
                <button onclick="showSection('wp')" class="flex-1 flex flex-col items-center py-2 text-gray-400 nav-btn" data-section="wp">
                    <i class="ri-building-line text-xl"></i>
                    <span class="text-xs mt-1">Data WP</span>
                </button>
                <button onclick="showSection('setting')" class="flex-1 flex flex-col items-center py-2 text-gray-400 nav-btn hidden" id="nav-setting" data-section="setting">
                    <i class="ri-settings-3-line text-xl"></i>
                    <span class="text-xs mt-1">Setting</span>
                </button>
            </div>
        </nav>

    </div>

    <!-- Floating Add Button -->
    <button id="fab-btn" onclick="openTambahModal()" class="hidden fixed bottom-24 right-4 w-14 h-14 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-full shadow-lg flex items-center justify-center hover:shadow-xl transition z-50">
        <i class="ri-add-line text-2xl"></i>
    </button>

    <!-- Modal Tambah -->
    <div id="modal-tambah" class="modal hidden fixed inset-0 bg-black/50 z-50 flex items-end justify-center">
        <div class="modal-content bg-white w-full max-w-lg rounded-t-2xl max-h-[90vh] overflow-y-auto">
            <div class="p-4 border-b border-gray-100 flex justify-between items-center sticky top-0 bg-white z-10">
                <h3 class="font-bold text-lg text-gray-800">Tambah Objek Pemungutan</h3>
                <button onclick="closeModal('tambah')" class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center text-gray-500 hover:bg-gray-200">
                    <i class="ri-close-line text-xl"></i>
                </button>
            </div>
            <form id="form-tambah" class="p-4 space-y-4">
                <div>
                    <label class="text-sm block mb-1 text-gray-600">Wajib Pajak *</label>
                    <select id="tambah-wp" required class="w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-blue-500 outline-none" onchange="updateTarif()">
                        <option value="">Pilih Wajib Pajak</option>
                    </select>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-sm block mb-1 text-gray-600">Omzet Makanan</label>
                        <input type="number" id="omzet-m" class="w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-blue-500 outline-none" placeholder="0" onkeyup="hitung()">
                    </div>
                    <div>
                        <label class="text-sm block mb-1 text-gray-600">Omzet Minuman</label>
                        <input type="number" id="omzet-n" class="w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-blue-500 outline-none" placeholder="0" onkeyup="hitung()">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-sm block mb-1 text-gray-600">Tarif Pajak %</label>
                        <input type="number" id="tarif" class="w-full px-4 py-3 border rounded-xl bg-gray-50" value="10" readonly>
                    </div>
                    <div>
                        <label class="text-sm block mb-1 text-gray-600">Status Pembayaran</label>
                        <select id="status" class="w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-blue-500 outline-none" onchange="toggleKet()">
                            <option value="Lunas">‚úÖ Lunas</option>
                            <option value="Belum Lunas">‚ùå Belum Lunas</option>
                            <option value="Janji Bayar">üìÖ Janji Bayar</option>
                            <option value="Tunggakan">‚ö†Ô∏è Tunggakan</option>
                        </select>
                    </div>
                </div>
                <div class="bg-gradient-to-r from-blue-50 to-blue-100 rounded-xl p-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <p class="text-xs text-gray-500">Total Omzet</p>
                            <p class="font-bold text-lg text-gray-800" id="total-omzet">Rp 0</p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-500">Pajak</p>
                            <p class="font-bold text-lg text-blue-600" id="total-pajak">Rp 0</p>
                        </div>
                    </div>
                </div>
                <div id="ket-section" class="hidden space-y-3 border-t border-gray-100 pt-4">
                    <div>
                        <label class="text-sm block mb-1 text-gray-600">Tanggal Janji Bayar</label>
                        <input type="date" id="tgl-janji" class="w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                    <div>
                        <label class="text-sm block mb-1 text-gray-600">Nomor Telepon</label>
                        <input type="tel" id="no-telp" class="w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-blue-500 outline-none" placeholder="08xxxxxxxx">
                    </div>
                    <div>
                        <label class="text-sm block mb-1 text-gray-600">Keterangan / Alasan</label>
                        <textarea id="ket" class="w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-blue-500 outline-none" rows="2" placeholder="Alasan belum bayar..."></textarea>
                    </div>
                </div>
                <div>
                    <label class="text-sm block mb-1 text-gray-600">Foto Bukti Pemungutan</label>
                    <input type="file" id="foto" accept="image/*" capture="environment" class="w-full px-4 py-3 border rounded-xl">
                </div>
                <button type="button" onclick="handleTambahSubmit()" class="w-full bg-gradient-to-r from-blue-600 to-blue-700 text-white py-3 rounded-xl font-medium hover:shadow-lg transition">
                    <i class="ri-save-line mr-2"></i>Simpan Data
                </button>
            </form>
        </div>
    </div>

    <!-- Modal WP -->
    <div id="modal-wp" class="modal hidden fixed inset-0 bg-black/50 z-50 flex items-end justify-center">
        <div class="modal-content bg-white w-full max-w-lg rounded-t-2xl max-h-[90vh] overflow-y-auto">
            <div class="p-4 border-b border-gray-100 flex justify-between items-center sticky top-0 bg-white z-10">
                <h3 class="font-bold text-lg text-gray-800" id="wp-modal-title">Tambah Wajib Pajak</h3>
                <button onclick="closeModal('wp')" class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center text-gray-500 hover:bg-gray-200">
                    <i class="ri-close-line text-xl"></i>
                </button>
            </div>
            <form id="form-wp" class="p-4 space-y-4" novalidate>
                <input type="hidden" id="wp-id">
                <div>
                    <label class="text-sm block mb-1 text-gray-600">NPWPD *</label>
                    <input type="text" id="wp-npwpd" required class="w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-blue-500 outline-none" placeholder="NPWPD">
                </div>
                <div>
                    <label class="text-sm block mb-1 text-gray-600">Nama Usaha *</label>
                    <input type="text" id="wp-nama" required class="w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Nama restoran/kafe">
                </div>
                <div>
                    <label class="text-sm block mb-1 text-gray-600">Nama Pemilik *</label>
                    <input type="text" id="wp-pemilik" required class="w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Nama pemilik">
                </div>
                <div>
                    <label class="text-sm block mb-1 text-gray-600">Alamat *</label>
                    <textarea id="wp-alamat" required class="w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-blue-500 outline-none" rows="2" placeholder="Alamat lengkap"></textarea>
                </div>
                <div>
                    <label class="text-sm block mb-1 text-gray-600">Tarif Pajak %</label>
                    <input type="number" id="wp-tarif" class="w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-blue-500 outline-none" value="10">
                </div>
                <button type="button" onclick="saveWP()" class="w-full bg-gradient-to-r from-blue-600 to-blue-700 text-white py-3 rounded-xl font-medium hover:shadow-lg transition">
                    <i class="ri-save-line mr-2"></i>Simpan Wajib Pajak
                </button>
            </form>
        </div>
    </div>

    <!-- Modal Petugas -->
    <div id="modal-petugas" class="modal hidden fixed inset-0 bg-black/50 z-50 flex items-end justify-center">
        <div class="modal-content bg-white w-full max-w-lg rounded-t-2xl">
            <div class="p-4 border-b border-gray-100 flex justify-between items-center">
                <h3 class="font-bold text-lg text-gray-800" id="petugas-modal-title">Tambah Petugas</h3>
                <button onclick="closeModal('petugas')" class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center text-gray-500 hover:bg-gray-200">
                    <i class="ri-close-line text-xl"></i>
                </button>
            </div>
            <form id="form-petugas" class="p-4 space-y-4" novalidate>
                <input type="hidden" id="petugas-id">
                <div>
                    <label class="text-sm block mb-1 text-gray-600">Nama *</label>
                    <input type="text" id="petugas-nama" required class="w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <div>
                    <label class="text-sm block mb-1 text-gray-600">NIP *</label>
                    <input type="text" id="petugas-nip" required class="w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <label class="flex items-center gap-3 cursor-pointer">
                    <input type="checkbox" id="petugas-aktif" class="w-5 h-5 text-blue-600 rounded">
                    <span class="text-sm text-gray-600">Jadikan petugas aktif</span>
                </label>
                <button type="button" onclick="savePetugas()" class="w-full bg-gradient-to-r from-blue-600 to-blue-700 text-white py-3 rounded-xl font-medium hover:shadow-lg transition">
                    <i class="ri-save-line mr-2"></i>Simpan Petugas
                </button>
            </form>
        </div>
    </div>

    <!-- Modal Pilih Petugas -->
    <div id="modal-pilih-petugas" class="modal hidden fixed inset-0 bg-black/50 z-50 flex items-end justify-center">
        <div class="modal-content bg-white w-full max-w-lg rounded-t-2xl max-h-[70vh] overflow-y-auto">
            <div class="p-4 border-b border-gray-100 flex justify-between items-center sticky top-0 bg-white z-10">
                <h3 class="font-bold text-lg text-gray-800">Pilih Petugas Aktif</h3>
                <button onclick="closeModal('pilih-petugas')" class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center text-gray-500 hover:bg-gray-200">
                    <i class="ri-close-line text-xl"></i>
                </button>
            </div>
            <div id="pilih-petugas-list" class="p-4 space-y-2"></div>
        </div>
    </div>

    <!-- Modal Edit -->
    <div id="modal-edit" class="modal hidden fixed inset-0 bg-black/50 z-50 flex items-end justify-center">
        <div class="modal-content bg-white w-full max-w-lg rounded-t-2xl">
            <div class="p-4 border-b border-gray-100 flex justify-between items-center">
                <h3 class="font-bold text-lg text-gray-800">Edit Status</h3>
                <button onclick="closeModal('edit')" class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center text-gray-500 hover:bg-gray-200">
                    <i class="ri-close-line text-xl"></i>
                </button>
            </div>
            <form id="form-edit" class="p-4 space-y-4">
                <input type="hidden" id="edit-id">
                <div class="bg-gray-50 rounded-xl p-4">
                    <p class="font-bold text-gray-800" id="edit-nama">-</p>
                    <p class="text-sm text-gray-600">Pajak: <span id="edit-pajak" class="text-blue-600 font-bold">-</span></p>
                </div>
                <div>
                    <label class="text-sm block mb-1 text-gray-600">Status</label>
                    <select id="edit-status" class="w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-blue-500 outline-none" onchange="toggleEditKet()">
                        <option value="Lunas">‚úÖ Lunas</option>
                        <option value="Belum Lunas">‚ùå Belum Lunas</option>
                        <option value="Janji Bayar">üìÖ Janji Bayar</option>
                        <option value="Tunggakan">‚ö†Ô∏è Tunggakan</option>
                    </select>
                </div>
                <div id="edit-ket-section" class="hidden space-y-3">
                    <div>
                        <label class="text-sm block mb-1 text-gray-600">Tanggal Janji Bayar</label>
                        <input type="date" id="edit-tgl-janji" class="w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                    <div>
                        <label class="text-sm block mb-1 text-gray-600">Nomor Telepon</label>
                        <input type="tel" id="edit-no-telp" class="w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                    <div>
                        <label class="text-sm block mb-1 text-gray-600">Keterangan</label>
                        <textarea id="edit-ket" class="w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-blue-500 outline-none" rows="2"></textarea>
                    </div>
                </div>
                <button type="submit" class="w-full bg-gradient-to-r from-blue-600 to-blue-700 text-white py-3 rounded-xl font-medium hover:shadow-lg transition">Simpan</button>
            </form>
        </div>
    </div>

    <!-- Modal Paraf -->
    <div id="modal-paraf" class="modal hidden fixed inset-0 bg-black/50 z-50 flex items-end justify-center">
        <div class="modal-content bg-white w-full max-w-lg rounded-t-2xl">
            <div class="p-4 border-b border-gray-100 flex justify-between items-center">
                <h3 class="font-bold text-lg text-gray-800">Paraf Wajib Pajak</h3>
                <button onclick="closeModal('paraf')" class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center text-gray-500 hover:bg-gray-200">
                    <i class="ri-close-line text-xl"></i>
                </button>
            </div>
            <div class="p-4">
                <p class="text-sm text-gray-600 mb-2" id="paraf-nama">-</p>
                <canvas id="signature-canvas" class="signature-canvas w-full h-40 border-2 border-gray-200 rounded-xl bg-white mb-3"></canvas>
                <div class="flex gap-2">
                    <button onclick="clearSignature()" class="flex-1 bg-gray-200 text-gray-700 py-2 rounded-lg">Hapus</button>
                    <button onclick="saveSignature()" class="flex-1 bg-blue-600 text-white py-2 rounded-lg">Simpan Paraf</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Reset Password -->
    <div id="modal-reset-password" class="modal hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center">
        <div class="bg-white rounded-2xl p-6 w-full max-w-sm mx-4">
            <div class="text-center mb-4">
                <div class="w-16 h-16 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-3">
                    <i class="ri-lock-unlock-line text-yellow-600 text-3xl"></i>
                </div>
                <h3 class="font-bold text-lg">Reset Password</h3>
                <p class="text-sm text-gray-500">Masukkan NIP untuk reset password</p>
            </div>
            <form id="form-reset-password" class="space-y-4">
                <input type="text" id="reset-nip" placeholder="NIP" required class="w-full px-4 py-3 border rounded-xl">
                <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-xl font-medium">Reset Password</button>
                <button type="button" onclick="closeModal('reset-password')" class="w-full bg-gray-200 text-gray-700 py-3 rounded-xl font-medium">Batal</button>
            </form>
        </div>
    </div>

    <!-- Modal Foto Preview -->
    <div id="modal-foto" class="modal hidden fixed inset-0 bg-black/90 z-50 flex items-center justify-center" onclick="closeModal('foto')">
        <div class="max-w-full max-h-full p-4">
            <img id="foto-preview" src="" class="max-w-full max-h-[80vh] rounded-lg">
        </div>
    </div>

    <!-- Modal Detail Kartu -->
    <div id="modal-detail" class="modal hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center">
        <div class="modal-content bg-white w-full max-w-lg rounded-t-2xl max-h-[90vh] overflow-y-auto">
            <div class="p-4 border-b border-gray-100 flex justify-between items-center sticky top-0 bg-white z-10">
                <h3 class="font-bold text-lg text-gray-800">Detail Kartu Kontrol</h3>
                <button onclick="closeModal('detail')" class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center text-gray-500 hover:bg-gray-200">
                    <i class="ri-close-line text-xl"></i>
                </button>
            </div>
            <div id="detail-content" class="p-4 space-y-4"></div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed top-4 left-4 right-4 bg-gray-800 text-white px-4 py-3 rounded-xl shadow-lg hidden z-50 text-center font-medium"></div>

    <!-- Print Area -->
    <div id="print-area" class="hidden print:block">
        <div class="p-6 max-w-4xl mx-auto">
            <div class="text-center border-b-2 border-black pb-4 mb-4">
                <h2 class="text-sm font-bold">PEMERINTAH KABUPATEN/KOTA <span id="print-daerah">-</span></h2>
                <h1 class="text-lg font-bold" id="print-dinas">-</h1>
                <h2 class="text-base font-bold underline mt-2">KARTU KONTROL PEMUNGUTAN PAJAK</h2>
                <p class="text-sm">Pajak Bukan Pemilik Kendaraan (PBJT) atas Makanan dan/atau Minuman</p>
            </div>
            <div class="mb-4 grid grid-cols-2 gap-4 text-sm">
                <div>
                    <p><strong>No. Kartu:</strong> <span id="print-no-kartu">-</span></p>
                    <p><strong>Tanggal:</strong> <span id="print-tanggal">-</span></p>
                    <p><strong>Jam:</strong> <span id="print-jam">-</span></p>
                </div>
                <div class="text-right">
                    <p><strong>Petugas:</strong> <span id="print-petugas">-</span></p>
                    <p><strong>NIP:</strong> <span id="print-nip">-</span></p>
                </div>
            </div>
            <table class="w-full text-sm mb-4" style="border-collapse: collapse;">
                <thead>
                    <tr class="bg-gray-200">
                        <th class="border border-black px-2 py-1 text-center">No</th>
                        <th class="border border-black px-2 py-1">NPWPD</th>
                        <th class="border border-black px-2 py-1">Nama WP</th>
                        <th class="border border-black px-2 py-1 text-right">Omzet</th>
                        <th class="border border-black px-2 py-1 text-center">%</th>
                        <th class="border border-black px-2 py-1 text-right">Pajak</th>
                        <th class="border border-black px-2 py-1 text-center">Status</th>
                        <th class="border border-black px-2 py-1">Ket</th>
                    </tr>
                </thead>
                <tbody id="print-table-body"></tbody>
                <tfoot>
                    <tr class="bg-gray-100 font-bold">
                        <td colspan="3" class="border border-black px-2 py-1 text-center">JUMLAH</td>
                        <td class="border border-black px-2 py-1 text-right" id="print-total-omzet">-</td>
                        <td class="border border-black"></td>
                        <td class="border border-black px-2 py-1 text-right" id="print-total-pajak">-</td>
                        <td colspan="2" class="border border-black"></td>
                    </tr>
                </tfoot>
            </table>
            <div class="grid grid-cols-3 gap-4 text-sm text-center">
                <div>
                    <p>Mengetahui,</p>
                    <p class="mt-16 underline" id="print-pejabat1">....................</p>
                    <p>NIP. <span id="print-nip1">....................</span></p>
                </div>
                <div>
                    <p>Petugas Pemungut,</p>
                    <p class="mt-16 underline" id="print-ttd-petugas">....................</p>
                    <p>NIP. <span id="print-ttd-nip">....................</span></p>
                </div>
                <div>
                    <p>Menyetujui,</p>
                    <p class="mt-16 underline" id="print-pejabat2">....................</p>
                    <p>NIP. <span id="print-nip2">....................</span></p>
                </div>
            </div>
        </div>
    </div>

    <style>
        @media print {
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            #print-area { position: absolute; left: 0; top: 0; width: 100%; }
        }
    </style>

    <script>
        // ==================== DATA & STATE ====================
        let users = [
            { username: 'admin', password: 'admin123', nama: 'Admin', nip: 'ADMIN001', role: 'admin' },
            { username: 'supervisor', password: 'supervisor123', nama: 'Budi Santoso', nip: 'SUPER001', role: 'admin' },
            { username: 'haris', password: 'haris123', nama: 'Haris', nip: '199001012015011001', role: 'petugas' },
            { username: 'rian', password: 'rian123', nama: 'Rian', nip: '199205022019031002', role: 'petugas' },
            { username: 'verifikator', password: 'verifikator123', nama: 'Verifikator', nip: 'VERIF001', role: 'verifikator' }
        ];
        let currentUser = null;
        let wajibPajak = JSON.parse(localStorage.getItem('pbjt-wp')) || [];
        let petugas = JSON.parse(localStorage.getItem('pbjt-petugas')) || [];
        let kartuKontrol = JSON.parse(localStorage.getItem('pbjt-kartu')) || [];
        let settings = JSON.parse(localStorage.getItem('pbjt-settings')) || { daerah: '', dinas: 'Dinas Pendapatan Daerah', tarifM: 10, tarifN: 10, pejabat1: '', nip1: '', pejabat2: '', nip2: '' };
        let activePetugasId = localStorage.getItem('pbjt-active-petugas') || '';
        let currentKartuId = null;
        let signaturePad = null;
        let currentParafId = null;
        
        // Firebase State
        let firebaseConfig = JSON.parse(localStorage.getItem('pbjt-firebase-config')) || null;
        let db = null;
        let isConnected = false;
        let autoSyncEnabled = localStorage.getItem('pbjt-auto-sync') === 'true';
        let syncOnOnlineEnabled = localStorage.getItem('pbjt-sync-on-online') === 'true';
        let lastSyncTime = localStorage.getItem('pbjt-last-sync') || null;
        let syncInProgress = false;

        // ==================== INITIALIZATION ====================
        document.addEventListener('DOMContentLoaded', () => {
            console.log('=== App Initializing ===');
            checkLogin();
            setupEventListeners();
            document.getElementById('filter-tanggal').valueAsDate = new Date();
            updateOnlineStatus();
            window.addEventListener('online', updateOnlineStatus);
            window.addEventListener('offline', updateOnlineStatus);
            
            // Auto-load Firebase if config exists (with error handling)
            if (firebaseConfig) {
                try {
                    loadFirebaseScripts();
                } catch (err) {
                    console.error('Error loading Firebase scripts:', err);
                    // Continue without Firebase - app still works
                }
            }
        });

        function checkLogin() {
            const user = JSON.parse(localStorage.getItem('pbjt-user'));
            if (user) {
                currentUser = user;
                showApp();
            }
        }

        function showApp() {
            console.log('=== showApp called ===');
            console.log('currentUser:', currentUser);
            console.log('currentUser role:', currentUser?.role);
            console.log('currentUser NIP:', currentUser?.nip);
            
            document.getElementById('login-page').classList.add('hidden');
            document.getElementById('app-container').classList.remove('hidden');
            console.log('DOM elements hidden/shown');
            
            init();
            
            // Force reload kartu kontrol after login to ensure FAB shows
            setTimeout(() => {
                const fabBtn = document.getElementById('fab-btn');
                if (fabBtn && currentUser) {
                    console.log('Force checking FAB visibility after login');
                    console.log('Current section:', document.querySelector('.nav-btn.active')?.dataset.section);
                    console.log('User role:', currentUser.role);
                    
                    // If petugas user and currently on kartu section, reload kartu kontrol
                    if (currentUser.role === 'petugas' || currentUser.role === 'admin' || currentUser.role === 'verifikator') {
                        console.log('Checking kartu section for FAB visibility');
                        // Check if there's a kartu for today
                        const today = new Date().toISOString().split('T')[0];
                        const p = getActivePetugas();
                        if (p) {
                            console.log('Active petugas on login check:', p);
                            console.log('Active petugas NIP:', p.nip);
                            
                            // Check if kartu exists for today and load if exists
                            const existingKartu = kartuKontrol.find(k => k.tanggal === today && k.petugasNip === p.nip);
                            if (existingKartu) {
                                console.log('Existing kartu found for today, setting currentKartuId:', existingKartu.id);
                                currentKartuId = existingKartu.id;
                            }
                            
                            // Force FAB to show after everything is loaded
                            setTimeout(() => {
                                const currentSection = document.querySelector('.nav-btn.active')?.dataset.section;
                                if (currentSection === 'kartu') {
                                    fabBtn.classList.remove('hidden');
                                    console.log('FAB button force shown in kartu section');
                                }
                            }, 500);
                        }
                    }
                }
            }, 1000);
        }

        function init() {
            try {
                console.log('=== init START ===');
                console.log('Current user:', currentUser);
                console.log('Current user role:', currentUser?.role);
                
                updateDate();
                renderAll();
                
                // Set petugas info based on user role
                if (currentUser && currentUser.role === 'petugas') {
                    console.log('Setting petugas info from user for petugas role');
                    updatePetugasInfoFromUser();
                } else {
                    console.log('Setting petugas info from localStorage');
                    updatePetugasInfo();
                }
                
                renderChart();
                updateTunggakanBadge();
                if (wajibPajak.length === 0) addSampleData();
                
                // Delay checkUserRole to ensure DOM is ready
                setTimeout(() => {
                    checkUserRole();
                }, 200);
                
                showOnlineStatus();
                console.log('=== init SUCCESS ===');
            } catch (e) {
                console.error('Error in init:', e);
                console.error('Error stack:', e.stack);
                // Make sure checkUserRole still runs even if init has errors
                setTimeout(() => {
                    checkUserRole();
                }, 300);
            }
        }

        function checkUserRole() {
            try {
                if (!currentUser) return;
                const roleBadge = document.getElementById('user-role');
                const navSetting = document.getElementById('nav-setting');
                const btnChangePetugas = document.getElementById('btn-change-petugas');
                
                console.log('=== checkUserRole ===');
                console.log('User role:', currentUser.role);
                console.log('User nama:', currentUser.nama);
                console.log('navSetting element:', navSetting);
                
                if (currentUser.role === 'admin') {
                    roleBadge.textContent = 'üîµ Administrator';
                    if (navSetting) navSetting.classList.remove('hidden');
                    if (btnChangePetugas) btnChangePetugas.classList.remove('hidden');
                    console.log('Admin: Setting menu VISIBLE');
                    
                    // Load petugas info from localStorage
                    updatePetugasInfo();
                } else if (currentUser.role === 'verifikator') {
                    roleBadge.textContent = 'üü£ Verifikator';
                    if (navSetting) navSetting.classList.add('hidden');
                    if (btnChangePetugas) btnChangePetugas.classList.add('hidden');
                    console.log('Verifikator: Setting menu HIDDEN, but sees ALL data');
                    
                    // Verifikator sees all data but no access to settings
                    updatePetugasInfo();
                } else {
                    roleBadge.textContent = 'üü¢ Petugas: ' + currentUser.nama;
                    if (navSetting) navSetting.classList.add('hidden');
                    if (btnChangePetugas) btnChangePetugas.classList.add('hidden');
                    console.log('Petugas: Setting menu HIDDEN');
                    console.log('Petugas NIP:', currentUser.nip);
                    
                    // Set petugas info based on logged-in user
                    updatePetugasInfoFromUser();
                }
            } catch (e) {
                console.error('Error in checkUserRole:', e);
            }
        }

        function updateDate() {
            document.getElementById('current-date').textContent = new Date().toLocaleDateString('id-ID', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
        }

        // ==================== EVENT LISTENERS ====================
        function setupEventListeners() {
            console.log('=== Setting up event listeners ===');

            // Login form
            document.getElementById('login-form').addEventListener('submit', function(e) {
                console.log('=== Login form submitted ===');
                e.preventDefault();
                const u = document.getElementById('login-username').value;
                const p = document.getElementById('login-password').value;
                console.log('Username/NIP:', u);
                console.log('Password:', p ? '***' : '(empty)');
                console.log('Users array:', users);
                const user = users.find(x => x.username === u || x.nip === u);
                console.log('Found user:', user);
                if (user && user.password === p) {
                    console.log('Login successful!');
                    console.log('User Role:', user.role);
                    console.log('User NIP:', user.nip);
                    console.log('User Name:', user.nama);
                    currentUser = user;
                    localStorage.setItem('pbjt-user', JSON.stringify(user));
                    showApp();
                    
                    // Double check user role after a short delay
                    setTimeout(() => {
                        console.log('Re-checking user role after login...');
                        checkUserRole();
                    }, 500);
                } else {
                    console.log('Login failed: wrong credentials');
                    showToast('Username atau password salah!');
                }
            });

            // Password change form
            document.getElementById('form-password').addEventListener('submit', function(e) {
                e.preventDefault();
                const old = document.getElementById('old-pass').value;
                const newp = document.getElementById('new-pass').value;
                if (currentUser.password === old) {
                    currentUser.password = newp;
                    localStorage.setItem('pbjt-user', JSON.stringify(currentUser));
                    showToast('Password berhasil diubah!');
                    this.reset();
                } else {
                    showToast('Password lama salah!');
                }
            });

            // Form tambah objek
            document.getElementById('form-tambah').addEventListener('submit', function(e) {
                e.preventDefault();
                addItem();
            });

            // Form edit
            document.getElementById('form-edit').addEventListener('submit', function(e) {
                e.preventDefault();
                saveEdit();
            });

            // Reset password form
            document.getElementById('form-reset-password').addEventListener('submit', function(e) {
                e.preventDefault();
                const nip = document.getElementById('reset-nip').value;
                const user = users.find(x => x.nip === nip);
                if (user) {
                    user.password = 'admin123';
                    showToast('Password di-reset ke: admin123');
                    closeModal('reset-password');
                    this.reset();
                } else {
                    showToast('NIP tidak ditemukan!');
                }
            });

            console.log('=== All event listeners setup complete ===');
        }

        function logout() {
            localStorage.removeItem('pbjt-user');
            location.reload();
        }

        // ==================== NAVIGATION ====================
        function showSection(sec) {
            console.log('=== showSection ===');
            console.log('Section:', sec);
            console.log('User role:', currentUser?.role);
            console.log('User NIP:', currentUser?.nip);
            
            // Double check role when accessing setting
            if (sec === 'setting') {
                if (!currentUser || currentUser.role !== 'admin') {
                    console.log('Access DENIED: Non-admin trying to access Setting');
                    showToast('Akses ditolak! Hubungi Administrator.');
                    return;
                }
                // Make sure setting menu is visible for admin
                const navSetting = document.getElementById('nav-setting');
                if (navSetting) navSetting.classList.remove('hidden');
                console.log('Admin accessing Setting - ALLOWED');
            }
            
            document.querySelectorAll('.section').forEach(el => el.classList.add('hidden'));
            document.getElementById('section-' + sec).classList.remove('hidden');
            document.querySelectorAll('.nav-btn').forEach(el => {
                el.classList.remove('active', 'text-blue-600');
                el.classList.add('text-gray-400');
            });
            const btn = document.querySelector(`[data-section="${sec}"]`);
            if (btn) {
                btn.classList.add('active', 'text-blue-600');
                btn.classList.remove('text-gray-400');
            }
            
            // Hide FAB by default
            const fabBtn = document.getElementById('fab-btn');
            if (fabBtn) {
                fabBtn.classList.add('hidden');
                console.log('FAB button hidden by default in showSection');
            }
            
            document.getElementById('page-title').textContent = { dashboard: 'Dashboard', kartu: 'Kartu Kontrol', tunggakan: 'Tunggakan', wp: 'Data WP', setting: 'Pengaturan' }[sec];
            
            if (sec === 'kartu') {
                // Show riwayat for admin and verifikator, single date view for petugas
                const riwayatSection = document.getElementById('kartu-riwayat-section');
                const tanggalSection = document.getElementById('kartu-tanggal-section');
                
                console.log('=== showSection kartu ===');
                console.log('User role:', currentUser?.role);
                console.log('Showing riwayat/tanggal section based on role');
                
                if (currentUser && (currentUser.role === 'admin' || currentUser.role === 'verifikator')) {
                    console.log('Admin/Verifikator: showing riwayat section');
                    riwayatSection.classList.remove('hidden');
                    tanggalSection.classList.add('hidden');
                    loadRiwayatKartu();
                } else {
                    console.log('Petugas: showing tanggal section');
                    riwayatSection.classList.add('hidden');
                    tanggalSection.classList.remove('hidden');
                    loadKartuKontrol();
                }
            }
            if (sec === 'tunggakan') loadTunggakan();
            if (sec === 'wp') renderWP();
            if (sec === 'setting') { renderPetugas(); loadSettings(); loadFirebaseConfig(); }
        }

        // ==================== MODALS ====================
        function openModal(name) {
            const m = document.getElementById('modal-' + name);
            m.classList.remove('hidden');
            if (name === 'tambah') {
                document.getElementById('form-tambah').reset();
                document.getElementById('total-omzet').textContent = 'Rp 0';
                document.getElementById('total-pajak').textContent = 'Rp 0';
                document.getElementById('ket-section').classList.add('hidden');
                updateWPDropdown();
            }
            if (name === 'wp') {
                document.getElementById('form-wp').reset();
                document.getElementById('wp-id').value = '';
                document.getElementById('wp-modal-title').textContent = 'Tambah Wajib Pajak';
            }
            if (name === 'petugas') {
                document.getElementById('form-petugas').reset();
                document.getElementById('petugas-id').value = '';
                document.getElementById('petugas-modal-title').textContent = 'Tambah Petugas';
            }
            if (name === 'pilih-petugas') renderPilihPetugas();
            if (name === 'paraf') initSignaturePad();
        }

        function closeModal(name) {
            document.getElementById('modal-' + name).classList.add('hidden');
        }

        function showResetPasswordModal() {
            openModal('reset-password');
        }

        function openTambahModal() {
            console.log('=== openTambahModal ===');
            console.log('currentUser:', currentUser);
            console.log('currentKartuId:', currentKartuId);
            console.log('kartuKontrol length:', kartuKontrol.length);
            
            const tgl = document.getElementById('filter-tanggal').value;
            console.log('Filter tanggal:', tgl);
            
            // Cek apakah user sudah login
            if (!currentUser) {
                showToast('Silakan login terlebih dahulu!');
                return;
            }
            
            // Cek currentKartuId
            if (!currentKartuId) {
                console.log('No currentKartuId');
                showToast('Kartu kontrol tidak ditemukan! Silakan buat kartu kontrol dulu dengan klik tombol "Buat Baru".');
                return;
            }
            
            // Cari kartu kontrol berdasarkan currentKartuId (lebih reliable)
            const kartu = kartuKontrol.find(k => k.id === currentKartuId);
            console.log('Kartu found by currentKartuId:', kartu ? kartu.noKartu : 'NO');
            
            if (!kartu) {
                console.log('Kartu control not found for currentKartuId:', currentKartuId);
                console.log('Available kartu IDs:', kartuKontrol.map(k => k.id));
                showToast('Kartu kontrol tidak ditemukan! Silakan buat kartu kontrol dulu.');
                return;
            }
            
            const p = getActivePetugas();
            console.log('Active petugas check:', p);
            
            if (!p) {
                showToast('Set petugas aktif terlebih dahulu!');
                console.log('No active petugas found');
                return;
            }
            
            console.log('All checks passed. Opening tambah modal...');
            openModal('tambah');
        }

        // ==================== KARTU KONTROL ====================
        function createNewKartu() {
            console.log('=== createNewKartu START ===');
            const tanggalInput = document.getElementById('filter-tanggal');
            if (!tanggalInput) {
                console.error('filter-tanggal element not found');
                showToast('Error: Tanggal input not found');
                return;
            }
            const tgl = tanggalInput.value;
            console.log('Filter tanggal:', tgl);
            console.log('Current user:', currentUser);
            console.log('User role:', currentUser?.role);
            
            // Get active petugas with fallback for petugas users
            let p = getActivePetugas();
            console.log('Active petugas from getActivePetugas:', p);
            
            // Additional fallback for petugas users
            if (!p && currentUser && currentUser.role === 'petugas') {
                console.log('Fallback: Using current user info for petugas');
                p = { id: currentUser.nip, nama: currentUser.nama, nip: currentUser.nip };
                console.log('Petugas info from user:', p);
            }
            
            console.log('Active petugas NIP:', p?.nip);
            console.log('Active petugas Nama:', p?.nama);
            
            if (!p) { 
                console.error('No active petugas found even after fallback');
                showToast('Data petugas tidak ditemukan! Silakan hubungi admin.'); 
                return; 
            }
            
            const existing = kartuKontrol.find(k => k.tanggal === tgl && k.petugasNip === p.nip);
            console.log('Existing kartu:', existing ? existing.noKartu : 'NO');
            
            if (existing) {
                currentKartuId = existing.id;
                loadKartuKontrol();
                showToast('Kartu kontrol sudah ada!');
                return;
            }
            
            // Generate unique kartu number based on petugas NIP
            const kartuCountForPetugas = kartuKontrol.filter(k => k.petugasNip === p.nip).length;
            const kartuNumber = String(kartuCountForPetugas + 1).padStart(3, '0');
            
            const kartu = {
                id: Date.now().toString(),
                noKartu: `KK-${tgl.replace(/-/g, '')}-${kartuNumber}`,
                tanggal: tgl,
                petugasId: p.id || p.nip,
                petugasNama: p.nama,
                petugasNip: p.nip,
                jamMulai: new Date().toTimeString().slice(0, 5),
                jamSelesai: '',
                items: []
            };
            
            console.log('Creating new kartu:', kartu);
            
            kartuKontrol.push(kartu);
            saveKartu();
            currentKartuId = kartu.id;
            
            // Force show FAB after creating new kartu with multiple checks
            const fabBtn = document.getElementById('fab-btn');
            if (fabBtn) {
                fabBtn.classList.remove('hidden');
                console.log('FAB button shown immediately');
                
                setTimeout(() => {
                    if (fabBtn) fabBtn.classList.remove('hidden');
                    console.log('FAB button force shown (50ms)');
                }, 50);
                
                setTimeout(() => {
                    if (fabBtn) fabBtn.classList.remove('hidden');
                    console.log('FAB button force shown (100ms)');
                }, 100);
            }
            
            loadKartuKontrol();
            showToast('Kartu kontrol dibuat! Silakan tambah objek pemungutan.');
            console.log('=== createNewKartu SUCCESS ===');
        }

        function loadKartuKontrol() {
            try {
                console.log('=== loadKartuKontrol START ===');
                
                // Get tanggal value safely
                const tanggalInput = document.getElementById('filter-tanggal');
                if (!tanggalInput) {
                    console.error('filter-tanggal element not found');
                    const kartuList = document.getElementById('kartu-list');
                    if (kartuList) {
                        kartuList.innerHTML = `<div class="bg-white rounded-xl p-8 text-center shadow-sm border border-gray-100">
                            <div class="text-yellow-500 mb-3"><i class="ri-error-warning-line text-4xl"></i></div>
                            <p class="text-gray-400">Error: Input tanggal tidak ditemukan</p>
                            <button onclick="location.reload()" class="mt-4 px-4 py-2 bg-blue-600 text-white rounded-lg text-sm">Refresh Halaman</button>
                        </div>`;
                    }
                    return;
                }
                const tgl = tanggalInput.value;
                console.log('Filter tanggal:', tgl);
                
                // Safely get filtered kartu
                let filteredKartu = [];
                try {
                    filteredKartu = getFilteredKartuKontrol();
                } catch (filterErr) {
                    console.error('Error in getFilteredKartuKontrol:', filterErr);
                    filteredKartu = kartuKontrol || [];
                }
                console.log('Filtered kartu count:', filteredKartu.length);
                console.log('User role:', currentUser?.role);
                console.log('User NIP:', currentUser?.nip);
                
                if (filteredKartu.length > 0) {
                    console.log('Filtered kartu:', filteredKartu.map(k => ({ no: k.noKartu, tanggal: k.tanggal, petugasNip: k.petugasNip })));
                }
                
                const kartu = filteredKartu.find(k => k.tanggal === tgl);
                console.log('Kartu found for date:', kartu ? kartu.noKartu : 'NO');
                
                if (kartu) {
                    currentKartuId = kartu.id;
                    
                    // Show kartu info safely
                    const kartuInfo = document.getElementById('kartu-info');
                    if (kartuInfo) kartuInfo.classList.remove('hidden');
                    
                    const noKartuEl = document.getElementById('info-no-kartu');
                    if (noKartuEl) noKartuEl.textContent = kartu.noKartu;
                    
                    const jamEl = document.getElementById('info-jam');
                    if (jamEl) jamEl.textContent = `${kartu.jamMulai} - ${kartu.jamSelesai || '-'}`;
                    
                    const petugasEl = document.getElementById('info-petugas');
                    if (petugasEl) petugasEl.textContent = kartu.petugasNama;
                    
                    const objekEl = document.getElementById('info-objek');
                    if (objekEl) objekEl.textContent = kartu.items.length;
                    
                    const lunas = kartu.items.filter(i => i.status === 'Lunas').length;
                    const tunggakan = kartu.items.filter(i => i.status !== 'Lunas').length;
                    
                    const lunasEl = document.getElementById('info-lunas');
                    if (lunasEl) lunasEl.textContent = lunas;
                    
                    const tunggakanEl = document.getElementById('info-tunggakan');
                    if (tunggakanEl) tunggakanEl.textContent = tunggakan;
                    
                    const kartuActions = document.getElementById('kartu-actions');
                    if (kartuActions) kartuActions.classList.remove('hidden');
                    
                    const jamSelesaiInput = document.getElementById('jam-selesai');
                    if (jamSelesaiInput) jamSelesaiInput.value = kartu.jamSelesai || '';
                    
                    // Show FAB button with error checking
                    const fabBtn = document.getElementById('fab-btn');
                    if (fabBtn) {
                        fabBtn.classList.remove('hidden');
                        console.log('FAB button SHOWN');
                    } else {
                        console.error('FAB button element not found!');
                    }
                    
                    const btnDetailKartu = document.getElementById('btn-detail-kartu');
                    if (btnDetailKartu) btnDetailKartu.classList.remove('hidden');
                    
                    try {
                        renderKartuItems(kartu);
                    } catch (renderErr) {
                        console.error('Error rendering kartu items:', renderErr);
                        const kartuList = document.getElementById('kartu-list');
                        if (kartuList) {
                            kartuList.innerHTML = `<div class="bg-white rounded-xl p-8 text-center shadow-sm border border-gray-100">
                                <div class="text-yellow-500 mb-3"><i class="ri-error-warning-line text-4xl"></i></div>
                                <p class="text-gray-400">Error menampilkan item</p>
                                <p class="text-sm text-gray-500 mt-2">${renderErr.message}</p>
                                <button onclick="loadKartuKontrol()" class="mt-4 px-4 py-2 bg-blue-600 text-white rounded-lg text-sm">Coba Lagi</button>
                            </div>`;
                        }
                    }
                    console.log('=== loadKartuKontrol SUCCESS: FAB SHOWN ===');
                } else {
                    currentKartuId = null;
                    
                    const kartuInfo = document.getElementById('kartu-info');
                    if (kartuInfo) kartuInfo.classList.add('hidden');
                    
                    const kartuActions = document.getElementById('kartu-actions');
                    if (kartuActions) kartuActions.classList.add('hidden');
                    
                    // Hide FAB button with error checking
                    const fabBtn = document.getElementById('fab-btn');
                    if (fabBtn) {
                        fabBtn.classList.add('hidden');
                        console.log('FAB button HIDDEN');
                    }
                    
                    const btnDetailKartu = document.getElementById('btn-detail-kartu');
                    if (btnDetailKartu) btnDetailKartu.classList.add('hidden');
                    
                    const kartuList = document.getElementById('kartu-list');
                    if (kartuList) {
                        kartuList.innerHTML = '<div class="bg-white rounded-xl p-8 text-center shadow-sm border border-gray-100"><p class="text-gray-400">Belum ada kartu. Klik "Buat Baru"</p></div>';
                    }
                    console.log('=== loadKartuKontrol: NO CARD FOUND ===');
                }
            } catch (error) {
                console.error('Error in loadKartuKontrol:', error);
                console.error('Error stack:', error.stack);
                const kartuList = document.getElementById('kartu-list');
                if (kartuList) {
                    kartuList.innerHTML = `<div class="bg-white rounded-xl p-8 text-center shadow-sm border border-gray-100">
                        <div class="text-red-500 mb-3"><i class="ri-error-warning-line text-4xl"></i></div>
                        <p class="text-red-500 font-medium">Error memuat kartu kontrol</p>
                        <p class="text-sm text-gray-500 mt-2">${error.message}</p>
                        <button onclick="location.reload()" class="mt-4 px-4 py-2 bg-blue-600 text-white rounded-lg text-sm">Refresh Halaman</button>
                    </div>`;
                }
            }
        }

        function loadRiwayatKartu() {
            const filter = document.getElementById('filter-riwayat')?.value || 'bulan-ini';
            const filteredKartu = getFilteredKartuKontrol();
            let filtered = [...filteredKartu];
            
            // Filter berdasarkan periode
            const now = new Date();
            if (filter === 'bulan-ini') {
                filtered = filteredKartu.filter(k => {
                    const d = new Date(k.tanggal);
                    return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
                });
            } else if (filter === 'bulan-lalu') {
                filtered = filteredKartu.filter(k => {
                    const d = new Date(k.tanggal);
                    const lastMonth = new Date(now.getFullYear(), now.getMonth() - 1);
                    return d.getMonth() === lastMonth.getMonth() && d.getFullYear() === lastMonth.getFullYear();
                });
            }
            
            // Sort berdasarkan tanggal terbaru
            filtered.sort((a, b) => new Date(b.tanggal) - new Date(a.tanggal));
            
            const statusConfig = {
                'Lunas': { bg: 'bg-green-100', text: 'text-green-700', icon: '‚úÖ' },
                'Belum Lunas': { bg: 'bg-red-100', text: 'text-red-700', icon: '‚ùå' },
                'Janji Bayar': { bg: 'bg-yellow-100', text: 'text-yellow-700', icon: 'üìÖ' },
                'Tunggakan': { bg: 'bg-orange-100', text: 'text-orange-700', icon: '‚ö†Ô∏è' }
            };
            
            document.getElementById('riwayat-list').innerHTML = filtered.map(kartu => {
                const totalOmzet = kartu.items.reduce((s, i) => s + i.omzet, 0);
                const totalPajak = kartu.items.reduce((s, i) => s + i.pajak, 0);
                const lunas = kartu.items.filter(i => i.status === 'Lunas').length;
                const tunggakan = kartu.items.filter(i => i.status !== 'Lunas').length;
                
                return `
                <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100 cursor-pointer hover:shadow-md transition" onclick="showDetailKartu('${kartu.id}')">
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-1">
                                <p class="font-bold text-gray-800">${kartu.noKartu}</p>
                                <span class="text-xs px-2 py-0.5 bg-blue-100 text-blue-700 rounded-full">${kartu.petugasNama}</span>
                            </div>
                            <p class="text-sm text-gray-500">${formatDate(kartu.tanggal)} | ${kartu.jamMulai} - ${kartu.jamSelesai || '-'}</p>
                        </div>
                        <span class="text-xs text-gray-400">${kartu.items.length} objek</span>
                    </div>
                    
                    <div class="grid grid-cols-4 gap-2 mb-3">
                        <div class="bg-gray-50 rounded-lg p-2 text-center">
                            <p class="text-xs text-gray-500">Objek</p>
                            <p class="font-bold text-gray-800">${kartu.items.length}</p>
                        </div>
                        <div class="bg-blue-50 rounded-lg p-2 text-center">
                            <p class="text-xs text-blue-500">Pajak</p>
                            <p class="font-bold text-blue-600 text-sm">${formatRupiahCompact(totalPajak)}</p>
                        </div>
                        <div class="bg-green-50 rounded-lg p-2 text-center">
                            <p class="text-xs text-green-500">Lunas</p>
                            <p class="font-bold text-green-600">${lunas}</p>
                        </div>
                        <div class="bg-red-50 rounded-lg p-2 text-center">
                            <p class="text-xs text-red-500">Tunggakan</p>
                            <p class="font-bold text-red-600">${tunggakan}</p>
                        </div>
                    </div>
                    
                    <div class="flex items-center justify-between text-xs text-gray-500 border-t border-gray-100 pt-2">
                        <span>NIP: ${kartu.petugasNip}</span>
                        <span><i class="ri-eye-line"></i> Klik untuk detail</span>
                    </div>
                    ${(currentUser && currentUser.role === 'admin') || (currentUser && currentUser.role === 'verifikator') ? `
                    <div class="flex gap-2 mt-3">
                        <button onclick="editKartuFromDetail('${kartu.id}')" class="flex-1 bg-blue-100 text-blue-700 py-2 rounded-lg text-sm font-medium flex items-center justify-center gap-1 hover:bg-blue-200 transition">
                            <i class="ri-add-line"></i> Tambah Objek
                        </button>
                        <button onclick="printKartuById('${kartu.id}')" class="flex-1 bg-green-100 text-green-700 py-2 rounded-lg text-sm font-medium flex items-center justify-center gap-1 hover:bg-green-200 transition">
                            <i class="ri-printer-line"></i> Cetak
                        </button>
                    </div>
                    ` : ''}
                </div>
            `}).join('') || '<div class="bg-white rounded-xl p-8 text-center shadow-sm border border-gray-100"><p class="text-gray-400">Belum ada kartu kontrol</p></div>';
        }

        function renderKartuItems(kartu) {
            const statusConfig = {
                'Lunas': { bg: 'bg-green-100', text: 'text-green-700', icon: '‚úÖ' },
                'Belum Lunas': { bg: 'bg-red-100', text: 'text-red-700', icon: '‚ùå' },
                'Janji Bayar': { bg: 'bg-yellow-100', text: 'text-yellow-700', icon: 'üìÖ' },
                'Tunggakan': { bg: 'bg-orange-100', text: 'text-orange-700', icon: '‚ö†Ô∏è' }
            };
            
            document.getElementById('kartu-list').innerHTML = kartu.items.map((item, i) => {
                const cfg = statusConfig[item.status] || statusConfig['Lunas'];
                return `
                <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100">
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-1">
                                <p class="font-bold text-gray-800">${item.wpNama}</p>
                                ${item.foto ? '<i class="ri-image-line text-blue-500"></i>' : ''}
                            </div>
                            <p class="text-sm text-gray-500">Omzet: ${formatRupiah(item.omzet)}</p>
                            ${item.tglParaf ? `<p class="text-xs text-blue-600"><i class="ri-pen-nib-line"></i> Paraf: ${formatDate(item.tglParaf)}</p>` : ''}
                        </div>
                        <span class="px-3 py-1 rounded-full text-xs font-medium ${cfg.bg} ${cfg.text}">${cfg.icon} ${item.status}</span>
                    </div>
                    <p class="font-bold text-lg text-blue-600 mb-2">${formatRupiah(item.pajak)}</p>
                    ${item.ket ? `<p class="text-sm text-gray-600 bg-gray-50 p-2 rounded-lg mb-2">${item.ket}</p>` : ''}
                    ${item.noTelp ? `<p class="text-sm text-gray-600"><i class="ri-phone-line"></i> ${item.noTelp}</p>` : ''}
                    <div class="flex gap-2 mt-3 pt-3 border-t border-gray-100">
                        <button onclick="openParafModal('${item.id}')" class="flex-1 flex items-center justify-center gap-1 py-2 rounded-lg text-sm ${item.paraf ? 'bg-blue-100 text-blue-700' : 'bg-gray-100 text-gray-600'}">
                            <i class="ri-pen-nib-line"></i> Paraf
                        </button>
                        <button onclick="editItem('${item.id}')" class="flex-1 flex items-center justify-center gap-1 py-2 rounded-lg text-sm bg-blue-100 text-blue-700">
                            <i class="ri-edit-line"></i> Edit
                        </button>
                        <button onclick="deleteItem('${item.id}')" class="flex-1 flex items-center justify-center gap-1 py-2 rounded-lg text-sm bg-red-100 text-red-700">
                            <i class="ri-delete-bin-line"></i> Hapus
                        </button>
                    </div>
                </div>
            `}).join('') || '<div class="bg-white rounded-xl p-8 text-center shadow-sm border border-gray-100"><p class="text-gray-400">Belum ada objek</p></div>';
        }

        function addItem() {
            console.log('=== addItem START ===');
            
            try {
                // Cek currentKartuId
                if (!currentKartuId) {
                    console.log('No currentKartuId');
                    showToast('Kartu kontrol tidak ditemukan! Silakan buat kartu kontrol dulu.');
                    return;
                }
                
                // Cari kartu kontrol
                const kartu = kartuKontrol.find(k => k.id === currentKartuId);
                console.log('Kartu found:', kartu ? 'YES' : 'NO');
                
                if (!kartu) {
                    console.log('Kartu control not found in kartuKontrol array');
                    showToast('Kartu kontrol tidak ditemukan! Silakan buat kartu kontrol dulu.');
                    return;
                }
                
                // Ambil nilai form
                const wpId = document.getElementById('tambah-wp').value;
                console.log('WP ID selected:', wpId);
                
                if (!wpId || wpId === '') {
                    showToast('Pilih Wajib Pajak!');
                    return;
                }
                
                const wp = wajibPajak.find(w => w.id === wpId);
                console.log('WP found:', wp ? 'YES' : 'NO');
                console.log('WP data:', wp);
                
                if (!wp) {
                    showToast('Wajib Pajak tidak ditemukan!');
                    return;
                }
                
                const omzetM = parseFloat(document.getElementById('omzet-m').value) || 0;
                const omzetN = parseFloat(document.getElementById('omzet-n').value) || 0;
                const tarif = parseFloat(document.getElementById('tarif').value) || 10;
                const status = document.getElementById('status').value;
                const omzet = omzetM + omzetN;
                const pajak = omzet * (tarif / 100);
                const tglJanji = document.getElementById('tgl-janji').value || null;
                const ket = document.getElementById('ket').value || '';
                const noTelp = document.getElementById('no-telp').value || '';
                const fotoInput = document.getElementById('foto');
                
                console.log('Data to save:');
                console.log('- WP:', wp.nama);
                console.log('- Omzet M:', omzetM);
                console.log('- Omzet N:', omzetN);
                console.log('- Total Omzet:', omzet);
                console.log('- Tarif:', tarif);
                console.log('- Pajak:', pajak);
                console.log('- Status:', status);
                console.log('- Tgl Janji:', tglJanji);
                console.log('- Ket:', ket);
                console.log('- No Telp:', noTelp);
                
                // Proses foto jika ada
                if (fotoInput.files && fotoInput.files[0]) {
                    console.log('Processing photo...');
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        console.log('Photo loaded, saving with photo...');
                        saveItemWithPhoto(kartu, wpId, wp, omzet, tarif, pajak, status, tglJanji, ket, noTelp, e.target.result);
                    };
                    reader.onerror = function(e) {
                        console.error('Error reading photo:', e);
                        showToast('Error membaca foto!');
                    };
                    reader.readAsDataURL(fotoInput.files[0]);
                    return;
                }
                
                // Simpan tanpa foto
                console.log('Saving without photo...');
                saveItemWithPhoto(kartu, wpId, wp, omzet, tarif, pajak, status, tglJanji, ket, noTelp, null);
                
            } catch (error) {
                console.error('Error in addItem:', error);
                console.error('Error stack:', error.stack);
                showToast('Error: ' + error.message);
            }
        }

        function saveItemWithPhoto(kartu, wpId, wp, omzet, tarif, pajak, status, tglJanji, ket, noTelp, foto) {
            console.log('=== saveItemWithPhoto START ===');
            console.log('Kartu ID:', kartu.id);
            console.log('WP:', wp.nama, ', Omzet:', omzet, ', Pajak:', pajak);
            console.log('Foto size:', foto ? foto.length : 'no photo');
            
            try {
                // Buat object item
                const item = {
                    id: Date.now().toString(),
                    wpId: wpId,
                    npwpd: wp.npwpd,
                    wpNama: wp.nama,
                    omzet: omzet,
                    tarif: tarif,
                    pajak: pajak,
                    status: status,
                    tglJanji: tglJanji,
                    ket: ket,
                    noTelp: noTelp,
                    foto: foto,
                    paraf: null,
                    tglParaf: null
                };
                
                console.log('Item object created:', item);
                
                // Tambah item ke kartu
                kartu.items.push(item);
                console.log('Item pushed to kartu.items. Total items:', kartu.items.length);
                
                // Simpan ke localStorage
                localStorage.setItem('pbjt-kartu', JSON.stringify(kartuKontrol));
                console.log('Kartu saved to localStorage');
                
                // Reload kartu kontrol
                loadKartuKontrol();
                console.log('Kartu kontrol reloaded');
                
                // Update stats
                updateStats();
                console.log('Stats updated');
                
                // Update badge
                updateTunggakanBadge();
                console.log('Badge updated');
                
                // Render chart
                renderChart();
                console.log('Chart rendered');
                
                // Tutup modal
                closeModal('tambah');
                console.log('Modal closed');
                
                // Show toast
                showToast('Data tersimpan!');
                console.log('=== saveItemWithPhoto SUCCESS ===');
                
            } catch (error) {
                console.error('Error in saveItemWithPhoto:', error);
                console.error('Error stack:', error.stack);
                showToast('Error menyimpan data: ' + error.message);
            }
        }

        function editItem(id) {
            const kartu = kartuKontrol.find(k => k.id === currentKartuId);
            const item = kartu.items.find(i => i.id === id);
            if (!item) return;
            
            document.getElementById('edit-id').value = id;
            document.getElementById('edit-nama').textContent = item.wpNama;
            document.getElementById('edit-pajak').textContent = formatRupiah(item.pajak);
            document.getElementById('edit-status').value = item.status;
            document.getElementById('edit-tgl-janji').value = item.tglJanji || '';
            document.getElementById('edit-no-telp').value = item.noTelp || '';
            document.getElementById('edit-ket').value = item.ket || '';
            toggleEditKet();
            openModal('edit');
        }

        function saveEdit() {
            const kartu = kartuKontrol.find(k => k.id === currentKartuId);
            const item = kartu.items.find(i => i.id === document.getElementById('edit-id').value);
            if (!item) return;
            
            item.status = document.getElementById('edit-status').value;
            item.tglJanji = document.getElementById('edit-tgl-janji').value || null;
            item.noTelp = document.getElementById('edit-no-telp').value || '';
            item.ket = document.getElementById('edit-ket').value || '';
            saveKartu();
            loadKartuKontrol();
            updateStats();
            updateTunggakanBadge();
            renderChart();
            closeModal('edit');
            showToast('Status diperbarui!');
        }

        function deleteItem(id) {
            if (!confirm('Hapus data ini?')) return;
            const kartu = kartuKontrol.find(k => k.id === currentKartuId);
            kartu.items = kartu.items.filter(i => i.id !== id);
            saveKartu();
            loadKartuKontrol();
            updateStats();
            updateTunggakanBadge();
            renderChart();
            showToast('Data dihapus!');
        }

        function saveJamSelesai() {
            const kartu = kartuKontrol.find(k => k.id === currentKartuId);
            if (kartu) {
                kartu.jamSelesai = document.getElementById('jam-selesai').value;
                saveKartu();
                document.getElementById('info-jam').textContent = `${kartu.jamMulai} - ${kartu.jamSelesai || '-'}`;
            }
        }

        function saveKartu() {
            try {
                localStorage.setItem('pbjt-kartu', JSON.stringify(kartuKontrol));
            } catch (error) {
                console.error('Error saving kartu:', error);
            }
        }

        // ==================== SIGNATURE ====================
        function initSignaturePad() {
            const canvas = document.getElementById('signature-canvas');
            const ctx = canvas.getContext('2d');
            
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            
            let isDrawing = false;
            let lastX = 0;
            let lastY = 0;
            
            function getPos(e) {
                const rect = canvas.getBoundingClientRect();
                if (e.touches) {
                    return { x: e.touches[0].clientX - rect.left, y: e.touches[0].clientY - rect.top };
                }
                return { x: e.clientX - rect.left, y: e.clientY - rect.top };
            }
            
            canvas.addEventListener('mousedown', (e) => {
                isDrawing = true;
                const pos = getPos(e);
                lastX = pos.x;
                lastY = pos.y;
            });
            
            canvas.addEventListener('mousemove', (e) => {
                if (!isDrawing) return;
                const pos = getPos(e);
                ctx.beginPath();
                ctx.moveTo(lastX, lastY);
                ctx.lineTo(pos.x, pos.y);
                ctx.stroke();
                lastX = pos.x;
                lastY = pos.y;
            });
            
            canvas.addEventListener('mouseup', () => isDrawing = false);
            canvas.addEventListener('mouseout', () => isDrawing = false);
            
            canvas.addEventListener('touchstart', (e) => {
                e.preventDefault();
                isDrawing = true;
                const pos = getPos(e);
                lastX = pos.x;
                lastY = pos.y;
            });
            
            canvas.addEventListener('touchmove', (e) => {
                e.preventDefault();
                if (!isDrawing) return;
                const pos = getPos(e);
                ctx.beginPath();
                ctx.moveTo(lastX, lastY);
                ctx.lineTo(pos.x, pos.y);
                ctx.stroke();
                lastX = pos.x;
                lastY = pos.y;
            });
            
            canvas.addEventListener('touchend', () => isDrawing = false);
            
            signaturePad = ctx;
        }

        function openParafModal(id) {
            currentParafId = id;
            const kartu = kartuKontrol.find(k => k.id === currentKartuId);
            const item = kartu.items.find(i => i.id === id);
            document.getElementById('paraf-nama').textContent = `Paraf untuk: ${item.wpNama}`;
            openModal('paraf');
        }

        function clearSignature() {
            const canvas = document.getElementById('signature-canvas');
            signaturePad.clearRect(0, 0, canvas.width, canvas.height);
        }

        function saveSignature() {
            const canvas = document.getElementById('signature-canvas');
            const dataUrl = canvas.toDataURL('image/png');
            const kartu = kartuKontrol.find(k => k.id === currentKartuId);
            const item = kartu.items.find(i => i.id === currentParafId);
            if (item) {
                item.paraf = dataUrl;
                item.tglParaf = new Date().toISOString();
                saveKartu();
                loadKartuKontrol();
                closeModal('paraf');
                showToast('Paraf tersimpan!');
            }
        }

        function handleTambahSubmit() {
            console.log('=== handleTambahSubmit START ===');
            
            try {
                // Cek apakah user sudah login
                if (!currentUser) {
                    showToast('Silakan login terlebih dahulu!');
                    return;
                }
                console.log('‚úì User logged in');
                
                // Cek currentKartuId
                if (!currentKartuId) {
                    showToast('Kartu kontrol tidak ditemukan! Silakan buat kartu kontrol dulu.');
                    return;
                }
                console.log('‚úì currentKartuId:', currentKartuId);
                
                // Cari kartu
                const kartu = kartuKontrol.find(k => k.id === currentKartuId);
                if (!kartu) {
                    console.error('Kartu tidak ditemukan di kartuKontrol');
                    showToast('Kartu kontrol tidak ditemukan!');
                    return;
                }
                console.log('‚úì Kartu found:', kartu.noKartu);
                
                // Ambil nilai dari form
                const wpId = document.getElementById('tambah-wp').value;
                console.log('WP ID selected:', wpId);
                
                if (!wpId || wpId === '') {
                    showToast('Pilih Wajib Pajak!');
                    return;
                }
                
                const wp = wajibPajak.find(w => w.id === wpId);
                if (!wp) {
                    console.error('Wajib Pajak tidak ditemukan');
                    showToast('Wajib Pajak tidak ditemukan!');
                    return;
                }
                console.log('‚úì WP found:', wp.nama);
                
                const omzetM = parseFloat(document.getElementById('omzet-m').value) || 0;
                const omzetN = parseFloat(document.getElementById('omzet-n').value) || 0;
                const tarif = parseFloat(document.getElementById('tarif').value) || 10;
                const status = document.getElementById('status').value;
                const omzet = omzetM + omzetN;
                const pajak = omzet * (tarif / 100);
                const tglJanji = document.getElementById('tgl-janji').value || null;
                const ket = document.getElementById('ket').value || '';
                const noTelp = document.getElementById('no-telp').value || '';
                
                console.log('Data to save:');
                console.log('- WP:', wp.nama);
                console.log('- Omzet M:', omzetM);
                console.log('- Omzet N:', omzetN);
                console.log('- Total Omzet:', omzet);
                console.log('- Tarif:', tarif);
                console.log('- Pajak:', pajak);
                console.log('- Status:', status);
                console.log('- Tgl Janji:', tglJanji);
                console.log('- Ket:', ket);
                console.log('- No Telp:', noTelp);
                
                // Proses foto
                const fotoInput = document.getElementById('foto');
                
                const processSave = (fotoData) => {
                    // Buat object item
                    const item = {
                        id: Date.now().toString(),
                        wpId: wpId,
                        npwpd: wp.npwpd,
                        wpNama: wp.nama,
                        omzet: omzet,
                        tarif: tarif,
                        pajak: pajak,
                        status: status,
                        tglJanji: tglJanji,
                        ket: ket,
                        noTelp: noTelp,
                        foto: fotoData,
                        paraf: null,
                        tglParaf: null
                    };
                    
                    console.log('=== Saving item ===');
                    console.log('Item object:', item);
                    
                    // Tambah item ke kartu
                    kartu.items.push(item);
                    console.log('‚úì Item pushed to kartu.items. Total items:', kartu.items.length);
                    
                    // Simpan ke localStorage
                    try {
                        localStorage.setItem('pbjt-kartu', JSON.stringify(kartuKontrol));
                        console.log('‚úì Kartu saved to localStorage');
                    } catch (err) {
                        console.error('Error saving to localStorage:', err);
                        showToast('Gagal menyimpan ke localStorage!');
                        return;
                    }
                    
                    // Update UI
                    loadKartuKontrol();
                    updateStats();
                    updateTunggakanBadge();
                    renderChart();
                    
                    // Tutup modal
                    closeModal('tambah');
                    
                    // Show toast
                    showToast('Data tersimpan!');
                    console.log('=== handleTambahSubmit SUCCESS ===');
                };
                
                if (fotoInput.files && fotoInput.files[0]) {
                    console.log('Processing photo...');
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        console.log('Photo loaded, saving with photo...');
                        processSave(e.target.result);
                    };
                    reader.onerror = function(e) {
                        console.error('Error reading photo:', e);
                        showToast('Error membaca foto!');
                    };
                    reader.readAsDataURL(fotoInput.files[0]);
                } else {
                    console.log('Saving without photo...');
                    processSave(null);
                }
                
            } catch (error) {
                console.error('=== handleTambahSubmit ERROR ===');
                console.error('Error:', error);
                console.error('Error stack:', error.stack);
                showToast('Error: ' + error.message);
            }
        }

        function showFoto(foto) {
            document.getElementById('foto-preview').src = foto;
            openModal('foto');
        }

        // ==================== DETAIL KARTU ====================
        function showDetailKartu(kartuId) {
            const kartu = kartuKontrol.find(k => k.id === kartuId);
            if (!kartu) return;

            const statusConfig = {
                'Lunas': { bg: 'bg-green-100', text: 'text-green-700', icon: '‚úÖ' },
                'Belum Lunas': { bg: 'bg-red-100', text: 'text-red-700', icon: '‚ùå' },
                'Janji Bayar': { bg: 'bg-yellow-100', text: 'text-yellow-700', icon: 'üìÖ' },
                'Tunggakan': { bg: 'bg-orange-100', text: 'text-orange-700', icon: '‚ö†Ô∏è' }
            };

            const totalOmzet = kartu.items.reduce((s, i) => s + i.omzet, 0);
            const totalPajak = kartu.items.reduce((s, i) => s + i.pajak, 0);
            const lunas = kartu.items.filter(i => i.status === 'Lunas').length;
            const tunggakan = kartu.items.filter(i => i.status !== 'Lunas').length;

            let html = `
                <div class="bg-gradient-to-r from-blue-500 to-blue-600 rounded-xl p-4 text-white">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <p class="text-xs text-blue-100">No. Kartu</p>
                            <p class="font-bold">${kartu.noKartu}</p>
                        </div>
                        <div class="text-right">
                            <p class="text-xs text-blue-100">Tanggal</p>
                            <p class="font-bold">${formatDate(kartu.tanggal)}</p>
                        </div>
                        <div>
                            <p class="text-xs text-blue-100">Jam</p>
                            <p class="font-bold">${kartu.jamMulai} - ${kartu.jamSelesai || '-'}</p>
                        </div>
                        <div class="text-right">
                            <p class="text-xs text-blue-100">Petugas</p>
                            <p class="font-bold">${kartu.petugasNama}</p>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-4 gap-2">
                    <div class="bg-white rounded-xl p-3 text-center border border-gray-100">
                        <p class="text-2xl font-bold text-blue-600">${kartu.items.length}</p>
                        <p class="text-xs text-gray-500">Objek</p>
                    </div>
                    <div class="bg-white rounded-xl p-3 text-center border border-gray-100">
                        <p class="text-xl font-bold text-green-600">${formatRupiahCompact(totalPajak)}</p>
                        <p class="text-xs text-gray-500">Total Pajak</p>
                    </div>
                    <div class="bg-white rounded-xl p-3 text-center border border-gray-100">
                        <p class="text-2xl font-bold text-green-600">${lunas}</p>
                        <p class="text-xs text-gray-500">Lunas</p>
                    </div>
                    <div class="bg-white rounded-xl p-3 text-center border border-gray-100">
                        <p class="text-2xl font-bold text-red-600">${tunggakan}</p>
                        <p class="text-xs text-gray-500">Tunggakan</p>
                    </div>
                </div>

                <h4 class="font-medium text-gray-700 mb-3">Daftar Objek Pemungutan</h4>
                <div class="space-y-3">
            `;

            kartu.items.forEach((item, idx) => {
                const cfg = statusConfig[item.status] || statusConfig['Lunas'];
                html += `
                    <div class="bg-white rounded-xl p-4 border border-gray-100">
                        <div class="flex justify-between items-start mb-3">
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="text-xs bg-blue-100 text-blue-700 px-2 py-0.5 rounded-full">${idx + 1}</span>
                                    <p class="font-bold text-gray-800">${item.wpNama}</p>
                                </div>
                                <p class="text-sm text-gray-500">${item.npwpd || '-'}</p>
                            </div>
                            <span class="px-3 py-1 rounded-full text-xs font-medium ${cfg.bg} ${cfg.text}">${cfg.icon} ${item.status}</span>
                        </div>

                        <div class="grid grid-cols-2 gap-2 mb-3 text-sm">
                            <div class="bg-gray-50 rounded-lg p-2">
                                <p class="text-xs text-gray-500">Omzet</p>
                                <p class="font-bold text-gray-800">${formatRupiah(item.omzet)}</p>
                            </div>
                            <div class="bg-blue-50 rounded-lg p-2">
                                <p class="text-xs text-blue-500">Pajak</p>
                                <p class="font-bold text-blue-600">${formatRupiah(item.pajak)}</p>
                            </div>
                        </div>

                        ${item.foto ? `
                        <div class="mb-3">
                            <p class="text-sm text-gray-600 mb-2"><i class="ri-image-line"></i> Foto Bukti Pemungutan</p>
                            <div onclick="showFoto('${item.foto}')" class="w-32 h-32 bg-gray-100 rounded-lg overflow-hidden cursor-pointer hover:opacity-80 transition">
                                <img src="${item.foto}" class="w-full h-full object-cover">
                            </div>
                        </div>
                        ` : ''}

                        ${item.paraf ? `
                        <div class="mb-3">
                            <p class="text-sm text-gray-600 mb-2"><i class="ri-pen-nib-line"></i> Paraf Wajib Pajak</p>
                            <div class="flex gap-2">
                                <div class="w-24 h-16 bg-gray-100 rounded-lg overflow-hidden border border-gray-200">
                                    <img src="${item.paraf}" class="w-full h-full object-contain bg-white">
                                </div>
                                <div class="flex-1 text-sm">
                                    <p class="text-gray-600">Tgl: ${formatDate(item.tglParaf)}</p>
                                </div>
                            </div>
                        </div>
                        ` : ''}

                        ${item.ket ? `
                        <div class="bg-yellow-50 rounded-lg p-3">
                            <p class="text-sm text-yellow-700"><i class="ri-file-text-line"></i> ${item.ket}</p>
                        </div>
                        ` : ''}
                    </div>
                `;
            });

            html += `</div>`;

            html += `</div>`;
            
            // Add action buttons for admin and verifikator to add items directly from detail view
            if (currentUser && (currentUser.role === 'admin' || currentUser.role === 'verifikator')) {
                html += `
                    <div class="mt-4 pt-4 border-t border-gray-200">
                        <button onclick="editKartuFromDetail('${kartu.id}')" class="w-full bg-blue-600 text-white py-3 rounded-xl font-medium hover:bg-blue-700 transition flex items-center justify-center gap-2">
                            <i class="ri-add-line"></i> Tambah Objek Pemungutan
                        </button>
                    </div>
                `;
            }
            
            document.getElementById('detail-content').innerHTML = html;
            openModal('detail');
        }
        
        function editKartuFromDetail(kartuId) {
            closeModal('detail');
            currentKartuId = kartuId;
            const kartu = kartuKontrol.find(k => k.id === kartuId);
            if (kartu) {
                console.log('=== editKartuFromDetail ===');
                console.log('Setting kartu ID:', kartuId);
                console.log('Setting tanggal:', kartu.tanggal);
                
                // Set tanggal to match the kartu
                document.getElementById('filter-tanggal').value = kartu.tanggal;
                // Switch to date view
                document.getElementById('kartu-riwayat-section').classList.add('hidden');
                document.getElementById('kartu-tanggal-section').classList.remove('hidden');
                
                // Show FAB for adding items with multiple delays to ensure it works
                const fabBtn = document.getElementById('fab-btn');
                if (fabBtn) {
                    fabBtn.classList.remove('hidden');
                    console.log('FAB button shown immediately');
                    
                    // Force show again after DOM updates
                    setTimeout(() => {
                        fabBtn.classList.remove('hidden');
                        console.log('FAB button forced shown (50ms)');
                    }, 50);
                    
                    setTimeout(() => {
                        fabBtn.classList.remove('hidden');
                        console.log('FAB button forced shown (100ms)');
                    }, 100);
                }
                
                // Load kartu items
                loadKartuKontrol();
                
                // Show toast
                showToast(`Kartu ${kartu.noKartu} aktif. Klik + untuk menambah objek.`);
            }
        }

        // ==================== WAJIB PAJAK ====================
        function saveWP() {
            const id = document.getElementById('wp-id').value || '';
            const npwpd = document.getElementById('wp-npwpd').value;
            const nama = document.getElementById('wp-nama').value;
            const pemilik = document.getElementById('wp-pemilik').value;
            const alamat = document.getElementById('wp-alamat').value;
            const tarif = parseFloat(document.getElementById('wp-tarif').value) || 10;

            if (!npwpd || !nama || !pemilik || !alamat) {
                showToast('Semua field wajib diisi!');
                return;
            }

            const data = { id: id || Date.now().toString(), npwpd, nama, pemilik, alamat, tarif };

            if (id) {
                const idx = wajibPajak.findIndex(w => w.id === id);
                if (idx !== -1) wajibPajak[idx] = data;
            } else {
                wajibPajak.push(data);
            }

            localStorage.setItem('pbjt-wp', JSON.stringify(wajibPajak));
            autoSyncWP();
            renderWP();
            closeModal('wp');
            showToast('Data tersimpan!');
        }

        function renderWP() {
            const search = document.getElementById('search-wp')?.value.toLowerCase() || '';
            const filtered = wajibPajak.filter(wp => wp.nama.toLowerCase().includes(search));
            document.getElementById('wp-list').innerHTML = filtered.map(wp => `
                <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100">
                    <div class="flex justify-between items-start">
                        <div onclick="editWP('${wp.id}')" class="flex-1 cursor-pointer">
                            <div class="flex items-center gap-2 mb-1">
                                <p class="font-bold text-gray-800">${wp.nama}</p>
                                <span class="text-xs px-2 py-0.5 bg-blue-100 text-blue-700 rounded-full">${wp.tarif}%</span>
                            </div>
                            <p class="text-sm text-gray-500">${wp.npwpd}</p>
                            <p class="text-xs text-gray-400 mt-1"><i class="ri-map-pin-line"></i> ${wp.alamat}</p>
                        </div>
                        <button onclick="deleteWP('${wp.id}')" class="w-10 h-10 rounded-full bg-red-100 flex items-center justify-center text-red-600 hover:bg-red-200">
                            <i class="ri-delete-bin-line"></i>
                        </button>
                    </div>
                </div>
            `).join('') || '<div class="bg-white rounded-xl p-8 text-center shadow-sm border border-gray-100"><p class="text-gray-400">Belum ada data WP</p></div>';
        }

        function editWP(id) {
            const wp = wajibPajak.find(w => w.id === id);
            if (wp) {
                document.getElementById('wp-id').value = wp.id;
                document.getElementById('wp-npwpd').value = wp.npwpd;
                document.getElementById('wp-nama').value = wp.nama;
                document.getElementById('wp-pemilik').value = wp.pemilik;
                document.getElementById('wp-alamat').value = wp.alamat;
                document.getElementById('wp-tarif').value = wp.tarif;
                document.getElementById('wp-modal-title').textContent = 'Edit Wajib Pajak';
                openModal('wp');
            }
        }

        function deleteWP(id) {
            if (!confirm('Hapus WP ini?')) return;
            wajibPajak = wajibPajak.filter(w => w.id !== id);
            localStorage.setItem('pbjt-wp', JSON.stringify(wajibPajak));
            autoSyncWP();
            renderWP();
            showToast('Data dihapus!');
        }

        function updateWPDropdown() {
            const sel = document.getElementById('tambah-wp');
            sel.innerHTML = '<option value="">Pilih Wajib Pajak</option>' + wajibPajak.map(w => `<option value="${w.id}">${w.nama}</option>`).join('');
        }

        function updateTarif() {
            const wp = wajibPajak.find(w => w.id === document.getElementById('tambah-wp').value);
            document.getElementById('tarif').value = wp ? wp.tarif : 10;
            hitung();
        }

        // ==================== PETUGAS ====================
        function savePetugas() {
            const id = document.getElementById('petugas-id').value || '';
            const nama = document.getElementById('petugas-nama').value;
            const nip = document.getElementById('petugas-nip').value;
            const aktif = document.getElementById('petugas-aktif')?.checked || false;

            if (!nama || !nip) {
                showToast('Nama dan NIP wajib diisi!');
                return;
            }

            const data = { id: id || Date.now().toString(), nama, nip };

            if (id) {
                const idx = petugas.findIndex(p => p.id === id);
                if (idx !== -1) petugas[idx] = data;
            } else {
                petugas.push(data);
            }

            localStorage.setItem('pbjt-petugas', JSON.stringify(petugas));
            autoSyncPetugas();

            if (aktif) {
                activePetugasId = data.id;
                localStorage.setItem('pbjt-active-petugas', data.id);
                updatePetugasInfo();
            }

            renderPetugas();
            closeModal('petugas');
            showToast('Data tersimpan!');
        }

        function renderPetugas() {
            document.getElementById('petugas-list').innerHTML = petugas.map(p => `
                <div class="flex justify-between items-center py-2 border-b border-gray-100 last:border-0">
                    <div>
                        <p class="font-medium text-gray-800">${p.nama}</p>
                        <p class="text-sm text-gray-500">NIP: ${p.nip}</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="editPetugas('${p.id}')" class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 hover:bg-blue-200">
                            <i class="ri-edit-line"></i>
                        </button>
                        <button onclick="deletePetugas('${p.id}')" class="w-8 h-8 rounded-full bg-red-100 flex items-center justify-center text-red-600 hover:bg-red-200">
                            <i class="ri-delete-bin-line"></i>
                        </button>
                    </div>
                </div>
            `).join('') || '<p class="text-gray-400 text-sm">Belum ada data petugas</p>';
        }

        function renderPilihPetugas() {
            document.getElementById('pilih-petugas-list').innerHTML = petugas.map(p => `
                <div class="flex justify-between items-center p-3 border rounded-xl cursor-pointer ${p.id === activePetugasId ? 'bg-blue-50 border-blue-500' : 'border-gray-100'}" onclick="setActivePetugas('${p.id}')">
                    <div>
                        <p class="font-medium text-gray-800">${p.nama}</p>
                        <p class="text-sm text-gray-500">NIP: ${p.nip}</p>
                    </div>
                    ${p.id === activePetugasId ? '<span class="text-blue-600 text-sm font-medium">‚úì Aktif</span>' : ''}
                </div>
            `).join('') || '<p class="text-gray-400 text-center py-4">Belum ada petugas</p>';
        }

        function editPetugas(id) {
            const p = petugas.find(x => x.id === id);
            if (p) {
                document.getElementById('petugas-id').value = p.id;
                document.getElementById('petugas-nama').value = p.nama;
                document.getElementById('petugas-nip').value = p.nip;
                document.getElementById('petugas-aktif').checked = p.id === activePetugasId;
                document.getElementById('petugas-modal-title').textContent = 'Edit Petugas';
                openModal('petugas');
            }
        }

        function deletePetugas(id) {
            if (!confirm('Hapus petugas ini?')) return;
            petugas = petugas.filter(p => p.id !== id);
            if (activePetugasId === id) activePetugasId = '';
            localStorage.setItem('pbjt-petugas', JSON.stringify(petugas));
            localStorage.setItem('pbjt-active-petugas', activePetugasId);
            autoSyncPetugas();
            renderPetugas();
            updatePetugasInfo();
            showToast('Data dihapus!');
        }

        function setActivePetugas(id) {
            activePetugasId = id;
            localStorage.setItem('pbjt-active-petugas', id);
            updatePetugasInfo();
            closeModal('pilih-petugas');
            showToast('Petugas aktif diubah!');
        }

        function openPetugasModal() {
            console.log('=== openPetugasModal ===', currentUser?.role);
            
            // Allow changing active petugas for both admin and petugas
            // Only restrict adding/editing petugas data for non-admin
            
            if (petugas.length > 0) {
                openModal('pilih-petugas');
            } else if (currentUser && currentUser.role === 'admin') {
                openModal('petugas');
            } else {
                showToast('Hubungi Administrator untuk menambah petugas.');
            }
        }

        function getActivePetugas() {
            console.log('=== getActivePetugas ===');
            console.log('Current user:', currentUser);
            console.log('User role:', currentUser?.role);
            console.log('User NIP:', currentUser?.nip);
            console.log('activePetugasId:', activePetugasId);
            console.log('Petugas array length:', petugas?.length);
            console.log('Petugas array:', petugas);
            
            // For petugas users, ALWAYS return their own info from currentUser
            if (currentUser && currentUser.role === 'petugas') {
                const petugasInfo = { id: currentUser.nip, nama: currentUser.nama, nip: currentUser.nip };
                console.log('Returning petugas user info:', petugasInfo);
                return petugasInfo;
            }
            
            // For admin and verifikator, get from localStorage petugas array
            const found = petugas.find(p => p.id === activePetugasId);
            if (found) {
                console.log('Returning active petugas from localStorage:', found);
                return found;
            }
            
            // Fallback to first petugas if exists (for admin/verifikator)
            if (petugas && petugas.length > 0) {
                console.log('Returning first petugas as fallback:', petugas[0]);
                return petugas[0];
            }
            
            console.log('No petugas found!');
            return null;
        }
        
        function getFilteredKartuKontrol() {
            // Admin and verifikator see all data, petugas only sees their own
            console.log('=== getFilteredKartuKontrol ===');
            console.log('User role:', currentUser?.role);
            console.log('User NIP:', currentUser?.nip);
            console.log('Total kartuKontrol:', kartuKontrol.length);
            
            if (currentUser && currentUser.role === 'petugas') {
                const filtered = kartuKontrol.filter(k => k.petugasNip === currentUser.nip);
                console.log('Filtered kartu (petugas):', filtered.length);
                return filtered;
            }
            // Admin and verifikator see all data
            console.log('All kartu (admin/verifikator):', kartuKontrol.length);
            return kartuKontrol;
        }

        function updatePetugasInfo() {
            const p = getActivePetugas();
            if (p) {
                document.getElementById('active-petugas-nama').textContent = p.nama || '-';
                document.getElementById('active-petugas-nip').textContent = p.nip || '-';
            }
        }
        
        function updatePetugasInfoFromUser() {
            console.log('=== updatePetugasInfoFromUser ===');
            console.log('Current user:', currentUser);
            // For petugas users, show their own info from currentUser
            if (currentUser && currentUser.role === 'petugas') {
                console.log('Setting petugas info from currentUser');
                console.log('User nama:', currentUser.nama);
                console.log('User NIP:', currentUser.nip);
                document.getElementById('active-petugas-nama').textContent = currentUser.nama || '-';
                document.getElementById('active-petugas-nip').textContent = currentUser.nip || '-';
                console.log('Petugas info set in UI');
            }
        }

        // ==================== HELPERS ====================
        // Force ensure FAB is visible if card exists
        function ensureFABVisibility() {
            try {
                const fabBtn = document.getElementById('fab-btn');
                const currentSection = document.querySelector('.section:not(.hidden)');
                
                if (!fabBtn || !currentSection) return;
                
                // Only show FAB on kartu section
                if (currentSection.id !== 'section-kartu') {
                    fabBtn.classList.add('hidden');
                    return;
                }
                
                // Check if current kartu exists
                const kartu = kartuKontrol.find(k => k.id === currentKartuId);
                
                if (kartu && kartu.items) {
                    fabBtn.classList.remove('hidden');
                    console.log('FAB button ensured visible (kartu exists)');
                } else {
                    fabBtn.classList.add('hidden');
                    console.log('FAB button hidden (no kartu)');
                }
            } catch (err) {
                console.error('Error in ensureFABVisibility:', err);
            }
        }
        
        function hitung() {
            const omzet = (parseFloat(document.getElementById('omzet-m').value) || 0) + (parseFloat(document.getElementById('omzet-n').value) || 0);
            const tarif = parseFloat(document.getElementById('tarif').value) || 10;
            const pajak = omzet * (tarif / 100);
            document.getElementById('total-omzet').textContent = formatRupiah(omzet);
            document.getElementById('total-pajak').textContent = formatRupiah(pajak);
        }

        function toggleKet() {
            const status = document.getElementById('status').value;
            document.getElementById('ket-section').classList.toggle('hidden', status === 'Lunas');
        }

        function toggleEditKet() {
            const status = document.getElementById('edit-status').value;
            document.getElementById('edit-ket-section').classList.toggle('hidden', status === 'Lunas');
        }

        function updateStats() {
            const today = new Date().toISOString().split('T')[0];
            const filteredKartu = getFilteredKartuKontrol();
            
            // Debug log untuk melihat data yang difilter
            console.log('=== updateStats ===');
            console.log('User role:', currentUser?.role);
            console.log('User NIP:', currentUser?.nip);
            console.log('Total kartuKontrol:', kartuKontrol.length);
            console.log('Filtered kartu (untuk stats):', filteredKartu.length);
            
            const todayKartu = filteredKartu.filter(k => k.tanggal === today);
            const todayItems = todayKartu.reduce((s, k) => s + k.items.length, 0);
            const todayPajak = todayKartu.reduce((s, k) => s + k.items.reduce((a, i) => a + i.pajak, 0), 0);
            
            console.log('Today kartu:', todayKartu.length);
            console.log('Today items:', todayItems);
            console.log('Today pajak:', todayPajak);
            
            document.getElementById('stat-hari-ini').textContent = todayItems;
            document.getElementById('stat-pajak-hari').textContent = formatRupiahCompact(todayPajak);

            const now = new Date();
            const monthKartu = filteredKartu.filter(k => {
                const d = new Date(k.tanggal);
                return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
            });
            const monthPajak = monthKartu.reduce((s, k) => s + k.items.reduce((a, i) => a + i.pajak, 0), 0);
            document.getElementById('stat-bulan').textContent = formatRupiahCompact(monthPajak);

            let tunggakan = 0;
            filteredKartu.forEach(k => k.items.forEach(i => { if (i.status !== 'Lunas') tunggakan += i.pajak; }));
            document.getElementById('stat-tunggakan').textContent = formatRupiahCompact(tunggakan);

            renderToday();
        }

        function renderToday() {
            const today = new Date().toISOString().split('T')[0];
            const filteredKartu = getFilteredKartuKontrol();
            const items = filteredKartu.filter(k => k.tanggal === today).flatMap(k => k.items);
            document.getElementById('today-count').textContent = `${items.length} data`;
            document.getElementById('today-list').innerHTML = items.slice(0, 5).map(item => {
                const statusClass = item.status === 'Lunas' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700';
                return `
                <div class="p-3 flex justify-between items-center">
                    <div>
                        <p class="font-medium text-gray-800">${item.wpNama}</p>
                        <span class="text-xs px-2 py-0.5 rounded-full ${statusClass}">${item.status}</span>
                    </div>
                    <p class="font-bold ${item.status === 'Lunas' ? 'text-green-600' : 'text-red-600'}">${formatRupiahCompact(item.pajak)}</p>
                </div>
            `}).join('') || '<p class="text-gray-400 text-center py-8 text-sm">Belum ada data</p>';
        }

        function renderChart() {
            const container = document.getElementById('chart-container');
            const days = [];
            for (let i = 6; i >= 0; i--) {
                const d = new Date();
                d.setDate(d.getDate() - i);
                days.push(d.toISOString().split('T')[0]);
            }
            
            const filteredKartu = getFilteredKartuKontrol();
            const values = days.map(day => {
                const kartu = filteredKartu.find(k => k.tanggal === day);
                return kartu ? kartu.items.reduce((s, i) => s + i.pajak, 0) : 0;
            });
            
            const max = Math.max(...values, 1);
            const dayLabels = ['Min', 'Sen', 'Sel', 'Rab', 'Kam', 'Jum', 'Sab'];
            
            container.innerHTML = values.map((v, i) => {
                const height = (v / max) * 100;
                const d = new Date(days[i]);
                return `
                <div class="flex-1 flex flex-col items-center">
                    <div class="w-full bg-blue-100 rounded-t-lg relative" style="height: ${Math.max(height, 5)}%">
                        <div class="absolute -top-6 left-1/2 -translate-x-1/2 text-xs text-gray-600 font-medium">${formatRupiahCompact(v)}</div>
                    </div>
                    <div class="w-full bg-blue-600 rounded-t-lg" style="height: ${Math.max(height - 3, 2)}%"></div>
                    <span class="text-xs text-gray-500 mt-1">${dayLabels[d.getDay()]}</span>
                </div>
            `}).join('');
        }

        function loadTunggakan() {
            const filter = document.getElementById('filter-status-tunggakan')?.value || '';
            const items = [];
            const filteredKartu = getFilteredKartuKontrol(); // Filter berdasarkan petugas
            filteredKartu.forEach(k => k.items.forEach(i => { 
                if (i.status !== 'Lunas' && (!filter || i.status === filter)) {
                    items.push({...i, tanggal: k.tanggal}); 
                }
            }));
            items.sort((a, b) => a.tanggal.localeCompare(b.tanggal));
            
            const statusConfig = {
                'Belum Lunas': { bg: 'bg-red-100', text: 'text-red-700', icon: '‚ùå' },
                'Janji Bayar': { bg: 'bg-yellow-100', text: 'text-yellow-700', icon: 'üìÖ' },
                'Tunggakan': { bg: 'bg-orange-100', text: 'text-orange-700', icon: '‚ö†Ô∏è' }
            };
            
            document.getElementById('tunggakan-list').innerHTML = items.map(item => {
                const cfg = statusConfig[item.status] || statusConfig['Belum Lunas'];
                return `
                <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <p class="font-bold text-gray-800">${item.wpNama}</p>
                            <p class="text-sm text-gray-500">${formatDate(item.tanggal)}</p>
                        </div>
                        <span class="px-3 py-1 rounded-full text-xs font-medium ${cfg.bg} ${cfg.text}">${cfg.icon} ${item.status}</span>
                    </div>
                    <p class="font-bold text-lg text-red-600 mb-2">${formatRupiah(item.pajak)}</p>
                    ${item.ket ? `<p class="text-sm text-gray-600 bg-gray-50 p-2 rounded-lg mb-2">${item.ket}</p>` : ''}
                    ${item.tglJanji ? `<p class="text-sm text-yellow-600"><i class="ri-calendar-line"></i> Janji bayar: ${formatDate(item.tglJanji)}</p>` : ''}
                    ${item.noTelp ? `<p class="text-sm text-gray-600"><i class="ri-phone-line"></i> ${item.noTelp}</p>` : ''}
                </div>
            `}).join('') || '<div class="bg-white rounded-xl p-8 text-center shadow-sm border border-gray-100"><p class="text-gray-400">Tidak ada tunggakan</p></div>';
        }

        function updateTunggakanBadge() {
            let count = 0;
            const filteredKartu = getFilteredKartuKontrol(); // Filter berdasarkan petugas
            filteredKartu.forEach(k => k.items.forEach(i => { if (i.status !== 'Lunas') count++; }));
            const badge = document.getElementById('tunggakan-badge');
            if (count > 0) {
                badge.textContent = count > 99 ? '99+' : count;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }

        function printKartu() {
            const kartu = kartuKontrol.find(k => k.id === currentKartuId);
            if (!kartu) { showToast('Pilih kartu kontrol!'); return; }
            
            document.getElementById('print-daerah').textContent = settings.daerah || '-';
            document.getElementById('print-dinas').textContent = settings.dinas;
            document.getElementById('print-no-kartu').textContent = kartu.noKartu;
            document.getElementById('print-tanggal').textContent = formatDate(kartu.tanggal);
            document.getElementById('print-jam').textContent = `${kartu.jamMulai} - ${kartu.jamSelesai || '-'}`;
            document.getElementById('print-petugas').textContent = kartu.petugasNama;
            document.getElementById('print-nip').textContent = kartu.petugasNip;
            document.getElementById('print-pejabat1').textContent = settings.pejabat1 || '....................';
            document.getElementById('print-nip1').textContent = settings.nip1 || '....................';
            document.getElementById('print-pejabat2').textContent = settings.pejabat2 || '....................';
            document.getElementById('print-nip2').textContent = settings.nip2 || '....................';
            
            document.getElementById('print-table-body').innerHTML = kartu.items.map((item, i) => `
                <tr>
                    <td class="border border-black px-2 py-1 text-center">${i + 1}</td>
                    <td class="border border-black px-2 py-1">${item.npwpd || '-'}</td>
                    <td class="border border-black px-2 py-1">${item.wpNama}</td>
                    <td class="border border-black px-2 py-1 text-right">${formatRupiah(item.omzet)}</td>
                    <td class="border border-black px-2 py-1 text-center">${item.tarif}</td>
                    <td class="border border-black px-2 py-1 text-right">${formatRupiah(item.pajak)}</td>
                    <td class="border border-black px-2 py-1 text-center">${item.status}</td>
                    <td class="border border-black px-2 py-1 text-xs">${item.ket || (item.tglJanji ? `Janji: ${formatDate(item.tglJanji)}` : '-')}</td>
                </tr>
            `).join('');
            
            const totalOmzet = kartu.items.reduce((s, i) => s + i.omzet, 0);
            const totalPajak = kartu.items.reduce((s, i) => s + i.pajak, 0);
            document.getElementById('print-total-omzet').textContent = formatRupiah(totalOmzet);
            document.getElementById('print-total-pajak').textContent = formatRupiah(totalPajak);
            document.getElementById('print-ttd-petugas').textContent = kartu.petugasNama;
            document.getElementById('print-ttd-nip').textContent = kartu.petugasNip;
            
            window.print();
        }
        
        function printKartuById(kartuId) {
            const kartu = kartuKontrol.find(k => k.id === kartuId);
            if (!kartu) { showToast('Kartu tidak ditemukan!'); return; }
            
            // Set current kartu for printing
            currentKartuId = kartu.id;
            
            document.getElementById('print-daerah').textContent = settings.daerah || '-';
            document.getElementById('print-dinas').textContent = settings.dinas;
            document.getElementById('print-no-kartu').textContent = kartu.noKartu;
            document.getElementById('print-tanggal').textContent = formatDate(kartu.tanggal);
            document.getElementById('print-jam').textContent = `${kartu.jamMulai} - ${kartu.jamSelesai || '-'}`;
            document.getElementById('print-petugas').textContent = kartu.petugasNama;
            document.getElementById('print-nip').textContent = kartu.petugasNip;
            document.getElementById('print-pejabat1').textContent = settings.pejabat1 || '....................';
            document.getElementById('print-nip1').textContent = settings.nip1 || '....................';
            document.getElementById('print-pejabat2').textContent = settings.pejabat2 || '....................';
            document.getElementById('print-nip2').textContent = settings.nip2 || '....................';
            
            document.getElementById('print-table-body').innerHTML = kartu.items.map((item, i) => `
                <tr>
                    <td class="border border-black px-2 py-1 text-center">${i + 1}</td>
                    <td class="border border-black px-2 py-1">${item.npwpd || '-'}</td>
                    <td class="border border-black px-2 py-1">${item.wpNama}</td>
                    <td class="border border-black px-2 py-1 text-right">${formatRupiah(item.omzet)}</td>
                    <td class="border border-black px-2 py-1 text-center">${item.tarif}</td>
                    <td class="border border-black px-2 py-1 text-right">${formatRupiah(item.pajak)}</td>
                    <td class="border border-black px-2 py-1 text-center">${item.status}</td>
                    <td class="border border-black px-2 py-1 text-xs">${item.ket || (item.tglJanji ? `Janji: ${formatDate(item.tglJanji)}` : '-')}</td>
                </tr>
            `).join('');
            
            const totalOmzet = kartu.items.reduce((s, i) => s + i.omzet, 0);
            const totalPajak = kartu.items.reduce((s, i) => s + i.pajak, 0);
            document.getElementById('print-total-omzet').textContent = formatRupiah(totalOmzet);
            document.getElementById('print-total-pajak').textContent = formatRupiah(totalPajak);
            document.getElementById('print-ttd-petugas').textContent = kartu.petugasNama;
            document.getElementById('print-ttd-nip').textContent = kartu.petugasNip;
            
            window.print();
        }

        function loadSettings() {
            document.getElementById('setting-daerah').value = settings.daerah || '';
            document.getElementById('setting-dinas').value = settings.dinas || '';
            document.getElementById('setting-tarif-m').value = settings.tarifM || 10;
            document.getElementById('setting-tarif-n').value = settings.tarifN || 10;
            document.getElementById('pejabat1').value = settings.pejabat1 || '';
            document.getElementById('nip1').value = settings.nip1 || '';
            document.getElementById('pejabat2').value = settings.pejabat2 || '';
            document.getElementById('nip2').value = settings.nip2 || '';
        }

        function saveSettings() {
            settings = {
                daerah: document.getElementById('setting-daerah').value,
                dinas: document.getElementById('setting-dinas').value,
                tarifM: parseFloat(document.getElementById('setting-tarif-m').value) || 10,
                tarifN: parseFloat(document.getElementById('setting-tarif-n').value) || 10,
                pejabat1: document.getElementById('pejabat1').value,
                nip1: document.getElementById('nip1').value,
                pejabat2: document.getElementById('pejabat2').value,
                nip2: document.getElementById('nip2').value
            };
            localStorage.setItem('pbjt-settings', JSON.stringify(settings));
            showToast('Pengaturan tersimpan!');
        }

        function exportToExcel() {
            try {
                if (typeof XLSX === 'undefined') {
                    showToast('Library Excel belum dimuat. Silakan refresh halaman.');
                    return;
                }

                const wb = XLSX.utils.book_new();

                // Sheet 1: Wajib Pajak
                const wpData = wajibPajak.map((wp, i) => ({
                    'No': i + 1,
                    'NPWPD': wp.npwpd,
                    'Nama Usaha': wp.nama,
                    'Nama Pemilik': wp.pemilik,
                    'Alamat': wp.alamat,
                    'Tarif Pajak (%)': wp.tarif
                }));
                const wsWP = XLSX.utils.json_to_sheet(wpData);
                XLSX.utils.book_append_sheet(wb, wsWP, 'Wajib Pajak');

                // Sheet 2: Petugas
                const petugasData = petugas.map((p, i) => ({
                    'No': i + 1,
                    'Nama': p.nama,
                    'NIP': p.nip,
                    'Status': p.id === activePetugasId ? 'Aktif' : 'Tidak Aktif'
                }));
                const wsPetugas = XLSX.utils.json_to_sheet(petugasData);
                XLSX.utils.book_append_sheet(wb, wsPetugas, 'Petugas');

                // Sheet 3: Rekap Per Petugas (Khusus Admin)
                const rekapPetugasData = [];
                kartuKontrol.forEach(kartu => {
                    // Hitung total per kartu
                    const totalOmzet = kartu.items.reduce((a, i) => a + i.omzet, 0);
                    const totalPajak = kartu.items.reduce((a, i) => a + i.pajak, 0);
                    const totalLunas = kartu.items.filter(i => i.status === 'Lunas').length;
                    const totalTunggakan = kartu.items.filter(i => i.status !== 'Lunas').length;
                    const totalTunggakanPajak = kartu.items.filter(i => i.status !== 'Lunas').reduce((a, i) => a + i.pajak, 0);
                    
                    rekapPetugasData.push({
                        'No. Kartu': kartu.noKartu,
                        'Tanggal': formatDate(kartu.tanggal),
                        'Petugas': kartu.petugasNama,
                        'NIP Petugas': kartu.petugasNip,
                        'Jam Mulai': kartu.jamMulai,
                        'Jam Selesai': kartu.jamSelesai || '-',
                        'Jumlah Objek': kartu.items.length,
                        'Total Omzet': totalOmzet,
                        'Total Pajak': totalPajak,
                        'Objek Lunas': totalLunas,
                        'Objek Tunggakan': totalTunggakan,
                        'Total Tunggakan Pajak': totalTunggakanPajak
                    });
                });
                
                // Sort berdasarkan tanggal
                rekapPetugasData.sort((a, b) => new Date(a['Tanggal']) - new Date(b['Tanggal']));
                
                // Tambahkan nomor urut
                rekapPetugasData.forEach((d, i) => d['No'] = i + 1);
                
                // Reorder columns
                const rekapPetugasOrdered = rekapPetugasData.map(d => ({
                    'No': d['No'],
                    'No. Kartu': d['No. Kartu'],
                    'Tanggal': d['Tanggal'],
                    'Petugas': d['Petugas'],
                    'NIP Petugas': d['NIP Petugas'],
                    'Jam Mulai': d['Jam Mulai'],
                    'Jam Selesai': d['Jam Selesai'],
                    'Jumlah Objek': d['Jumlah Objek'],
                    'Total Omzet': d['Total Omzet'],
                    'Total Pajak': d['Total Pajak'],
                    'Objek Lunas': d['Objek Lunas'],
                    'Objek Tunggakan': d['Objek Tunggakan'],
                    'Total Tunggakan Pajak': d['Total Tunggakan Pajak']
                }));
                
                const wsRekap = XLSX.utils.json_to_sheet(rekapPetugasOrdered);
                XLSX.utils.book_append_sheet(wb, wsRekap, 'Rekap Per Petugas');

                // Sheet 4: Detail Semua Transaksi
                const kartuRows = [];
                kartuKontrol.forEach(kartu => {
                    kartu.items.forEach((item, idx) => {
                        kartuRows.push({
                            'No. Kartu': kartu.noKartu,
                            'Tanggal': formatDate(kartu.tanggal),
                            'Jam': kartu.jamMulai + ' - ' + (kartu.jamSelesai || '-'),
                            'Petugas': kartu.petugasNama,
                            'NIP Petugas': kartu.petugasNip,
                            'No': idx + 1,
                            'NPWPD': item.npwpd || '-',
                            'Nama WP': item.wpNama,
                            'Omzet': item.omzet,
                            'Tarif (%)': item.tarif,
                            'Pajak': item.pajak,
                            'Status': item.status,
                            'Tanggal Paraf': item.tglParaf ? formatDate(item.tglParaf) : '-',
                            'Ada Foto': item.foto ? 'Ya' : 'Tidak',
                            'Keterangan': item.ket || '-',
                            'No. Telp': item.noTelp || '-',
                            'Janji Bayar': item.tglJanji ? formatDate(item.tglJanji) : '-'
                        });
                    });
                });
                const wsKartu = XLSX.utils.json_to_sheet(kartuRows);
                XLSX.utils.book_append_sheet(wb, wsKartu, 'Detail Transaksi');

                // Sheet 5: Ringkasan
                const totalOmzet = kartuKontrol.reduce((s, k) => s + k.items.reduce((a, i) => a + i.omzet, 0), 0);
                const totalPajak = kartuKontrol.reduce((s, k) => s + k.items.reduce((a, i) => a + i.pajak, 0), 0);
                const totalLunas = kartuKontrol.reduce((s, k) => s + k.items.filter(i => i.status === 'Lunas').length, 0);
                let totalTunggakan = 0;
                let totalTunggakanCount = 0;
                kartuKontrol.forEach(k => {
                    k.items.forEach(i => {
                        if (i.status !== 'Lunas') {
                            totalTunggakan += i.pajak;
                            totalTunggakanCount++;
                        }
                    });
                });

                // Ringkasan per petugas
                let rekapPerPetugasText = '';
                kartuKontrol.forEach(kartu => {
                    const pajakKartu = kartu.items.reduce((a, i) => a + i.pajak, 0);
                    const omzetKartu = kartu.items.reduce((a, i) => a + i.omzet, 0);
                    rekapPerPetugasText += `${kartu.petugasNama}: ${kartu.items.length} objek, ${formatRupiah(pajakKartu)} pajak\n`;
                });

                const ringkasanData = [
                    { 'Keterangan': 'Jumlah Wajib Pajak', 'Nilai': wajibPajak.length },
                    { 'Keterangan': 'Jumlah Petugas', 'Nilai': petugas.length },
                    { 'Keterangan': 'Jumlah Kartu Kontrol', 'Nilai': kartuKontrol.length },
                    { 'Keterangan': 'Total Transaksi', 'Nilai': kartuKontrol.reduce((s, k) => s + k.items.length, 0) },
                    { 'Keterangan': 'Total Omzet', 'Nilai': formatRupiah(totalOmzet) },
                    { 'Keterangan': 'Total Pajak', 'Nilai': formatRupiah(totalPajak) },
                    { 'Keterangan': 'Transaksi Lunas', 'Nilai': totalLunas },
                    { 'Keterangan': 'Transaksi Tunggakan', 'Nilai': totalTunggakanCount },
                    { 'Keterangan': 'Total Tunggakan', 'Nilai': formatRupiah(totalTunggakan) },
                    { 'Keterangan': 'Tanggal Export', 'Nilai': new Date().toLocaleString('id-ID') },
                    { 'Keterangan': 'Export Oleh', 'Nilai': currentUser ? currentUser.nama : '-' }
                ];
                
                // Tambahkan rekap per petugas
                if (currentUser && currentUser.role === 'admin') {
                    ringkasanData.push({ 'Keterangan': '', 'Nilai': '' });
                    ringkasanData.push({ 'Keterangan': 'REKAP PER PETUGAS', 'Nilai': '' });
                    kartuKontrol.forEach(kartu => {
                        const pajakKartu = kartu.items.reduce((a, i) => a + i.pajak, 0);
                        const objekLunas = kartu.items.filter(i => i.status === 'Lunas').length;
                        const objekTunggakan = kartu.items.filter(i => i.status !== 'Lunas').length;
                        const tunggakanPajak = kartu.items.filter(i => i.status !== 'Lunas').reduce((a, i) => a + i.pajak, 0);
                        
                        ringkasanData.push(
                            { 'Keterangan': `${kartu.petugasNama} (${kartu.petugasNip})`, 'Nilai': '' },
                            { 'Keterangan': '- Jumlah Kartu', 'Nilai': kartuKontrol.filter(k => k.petugasNip === kartu.petugasNip).length },
                            { 'Keterangan': '- Total Objek', 'Nilai': kartu.items.length },
                            { 'Keterangan': '- Objek Lunas', 'Nilai': objekLunas },
                            { 'Keterangan': '- Objek Tunggakan', 'Nilai': objekTunggakan },
                            { 'Keterangan': '- Total Pajak', 'Nilai': formatRupiah(pajakKartu) },
                            { 'Keterangan': '- Tunggakan Pajak', 'Nilai': formatRupiah(tunggakanPajak) },
                            { 'Keterangan': '', 'Nilai': '' }
                        );
                    });
                }
                
                const wsRingkasan = XLSX.utils.json_to_sheet(ringkasanData);
                XLSX.utils.book_append_sheet(wb, wsRingkasan, 'Ringkasan');

                const fileName = `PBJT-Export-${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, fileName);

                showToast('Export Excel berhasil! üìä');
            } catch (error) {
                console.error('Export Excel error:', error);
                showToast('Export Excel gagal: ' + error.message);
            }
        }

        function exportData() {
            const data = { wajibPajak, petugas, kartuKontrol, settings, exportDate: new Date().toISOString() };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `pbjt-backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            showToast('Data di-export!');
        }

        function importData(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                try {
                    const data = JSON.parse(ev.target.result);
                    if (data.wajibPajak) wajibPajak = data.wajibPajak;
                    if (data.petugas) petugas = data.petugas;
                    if (data.kartuKontrol) kartuKontrol = data.kartuKontrol;
                    if (data.settings) settings = data.settings;
                    localStorage.setItem('pbjt-wp', JSON.stringify(wajibPajak));
                    localStorage.setItem('pbjt-petugas', JSON.stringify(petugas));
                    localStorage.setItem('pbjt-kartu', JSON.stringify(kartuKontrol));
                    localStorage.setItem('pbjt-settings', JSON.stringify(settings));
                    renderAll();
                    manualSync();
                    showToast('Data di-import!');
                } catch (err) {
                    showToast('File tidak valid!');
                }
            };
            reader.readAsText(file);
        }

        function resetData() {
            if (!confirm('Hapus semua data? Tindakan ini tidak dapat dibatalkan!')) return;
            localStorage.clear();
            location.reload();
        }

        // ==================== FIREBASE ====================
        function loadFirebaseScripts() {
            console.log('=== Loading Firebase Scripts ===');
            updateSyncStatus('üü°', 'Memuat Firebase...', 'Menghubungkan ke database');
            
            // Load Firebase App
            const scriptApp = document.createElement('script');
            scriptApp.src = 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js';
            scriptApp.onload = () => {
                console.log('‚úì Firebase App script loaded');
                console.log('window.firebase available:', typeof window.firebase !== 'undefined');
                
                // Load Firebase Database
                const scriptDB = document.createElement('script');
                scriptDB.src = 'https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js';
                scriptDB.onload = () => {
                    console.log('‚úì Firebase Database script loaded');
                    console.log('window.firebase.database available:', typeof window.firebase.database !== 'undefined');
                    initFirebase();
                };
                scriptDB.onerror = () => {
                    console.error('‚úó Failed to load Firebase Database script');
                    updateSyncStatus('üî¥', 'Gagal Memuat', 'Gagal memuat Firebase Database');
                };
                document.head.appendChild(scriptDB);
            };
            scriptApp.onerror = () => {
                console.error('‚úó Failed to load Firebase App script');
                updateSyncStatus('üî¥', 'Gagal Memuat', 'Gagal memuat Firebase App');
            };
            document.head.appendChild(scriptApp);
            console.log('=== Firebase Scripts loading initiated ===');
        }

        function initFirebase() {
            console.log('=== initFirebase START ===');
            console.log('firebaseConfig:', firebaseConfig ? 'EXISTS' : 'NOT SET');
            console.log('window.firebase:', typeof window.firebase !== 'undefined' ? 'AVAILABLE' : 'NOT AVAILABLE');
            
            if (!firebaseConfig) {
                console.log('‚úó Firebase config not available');
                return;
            }
            
            if (!window.firebase) {
                console.log('‚úó Firebase object not available');
                return;
            }

            try {
                console.log('Initializing Firebase with config:', {
                    projectId: firebaseConfig.projectId,
                    databaseURL: firebaseConfig.databaseURL
                });
                
                window.firebase.initializeApp(firebaseConfig);
                db = window.firebase.database();
                isConnected = true;
                
                console.log('‚úì Firebase app initialized');
                console.log('‚úì Firebase database reference created');
                console.log('‚úì isConnected = true');
                
                updateSyncStatus('üü¢', 'Terhubung ke Firebase', 'Data tersinkronisasi secara otomatis');
                
                loadSyncSettings();
                
                // Setup realtime sync with error handling
                try {
                    console.log('Setting up realtime sync listener...');
                    setupRealtimeSync();
                    console.log('‚úì Realtime sync listener setup complete');
                } catch (syncErr) {
                    console.error('Error setting up realtime sync:', syncErr);
                    // Continue even if realtime sync fails
                }
                
                if (autoSyncEnabled) {
                    console.log('Auto-sync enabled, triggering manual sync in 1 second...');
                    setTimeout(() => manualSync(), 1000);
                }
                
                console.log('=== initFirebase SUCCESS ===');
            } catch (err) {
                console.error('=== initFirebase ERROR ===');
                console.error('Error code:', err.code);
                console.error('Error message:', err.message);
                
                if (err.code === 'app/duplicate-app') {
                    console.log('Firebase app already exists, reusing');
                    db = window.firebase.database();
                    isConnected = true;
                    updateSyncStatus('üü¢', 'Terhubung ke Firebase', 'Data tersinkronisasi secara otomatis');
                    loadSyncSettings();
                    try {
                        setupRealtimeSync();
                    } catch (syncErr) {
                        console.error('Error setting up realtime sync:', syncErr);
                    }
                    console.log('=== initFirebase SUCCESS (using existing app) ===');
                } else {
                    console.error('Firebase init error');
                    updateSyncStatus('üî¥', 'Koneksi Gagal', err.message);
                    // Don't block the app - continue with local storage
                    isConnected = false;
                    console.log('=== initFirebase FAILED (continuing with local storage) ===');
                }
            }
        }

        function setupRealtimeSync() {
            if (!db) return;
            
            console.log('=== setupRealtimeSync START ===');
            console.log('typeof db.ref:', typeof db.ref);
            console.log('db.ref exists:', typeof db.ref === 'function');
            
            try {
                // Initialize arrays if needed - with safety check
                if (!Array.isArray(wajibPajak)) {
                    console.warn('wajibPajak is not an array, initializing...');
                    wajibPajak = [];
                }
                if (!Array.isArray(petugas)) {
                    console.warn('petugas is not an array, initializing...');
                    petugas = [];
                }
                if (!Array.isArray(kartuKontrol)) {
                    console.warn('kartuKontrol is not an array, initializing...');
                    kartuKontrol = [];
                }
                
                console.log('Setting up realtime value listener...');
                
                // Check if db.ref is a function before using it
                if (typeof db.ref !== 'function') {
                    console.error('db.ref is not a function, cannot setup realtime sync');
                    return;
                }
                
                const ref = db.ref('/');
                if (!ref) {
                    console.error('db.ref(\"/\") returned undefined');
                    return;
                }
                
                // Listen for data changes from Firebase
                ref.on('value', (snapshot) => {
                    try {
                        const data = snapshot.val();
                        if (!data) {
                            console.log('No data from Firebase');
                            return;
                        }
                        
                        console.log('=== Reading data from Firebase (PUSH) ===');
                        console.log('Data type:', typeof data);
                        console.log('Data keys:', Object.keys(data));
                        
                        // Helper function to safely sync arrays
                        const syncArray = (key, target, renderFn, saveKey) => {
                            if (data[key]) {
                                const source = data[key];
                                if (!Array.isArray(source)) {
                                    console.error(`${key} from Firebase is not an array, it's ${typeof source}:`, source);
                                    return;
                                }
                                if (JSON.stringify(source) !== JSON.stringify(target)) {
                                    console.log(`Syncing ${key}...`);
                                    // Assign safely without using .push()
                                    for (let i = 0; i < source.length; i++) {
                                        if (!target[i]) target[i] = source[i];
                                    }
                                    localStorage.setItem(saveKey, JSON.stringify(target));
                                    if (renderFn) renderFn();
                                    console.log(`${key} synced from Firebase`);
                                }
                            }
                        };
                        
                        // Sync all data arrays safely
                        syncArray('wajibPajak', wajibPajak, renderWP, 'pbjt-wp');
                        syncArray('petugas', petugas, renderPetugas, 'pbjt-petugas');
                        syncArray('kartuKontrol', kartuKontrol, () => {
                            updateStats();
                            renderChart();
                            updateTunggakanBadge();
                            if (currentKartuId) loadKartuKontrol();
                        }, 'pbjt-kartu');
                        
                        // Update settings separately
                        if (data.settings && typeof data.settings === 'object') {
                            if (JSON.stringify(data.settings) !== JSON.stringify(settings)) {
                                console.log('Syncing settings...');
                                settings = data.settings;
                                localStorage.setItem('pbjt-settings', JSON.stringify(settings));
                                console.log('Settings synced from Firebase');
                            }
                        }
                        
                        updateLastSyncTime();
                        console.log('=== Firebase data read successfully ===');
                    } catch (err) {
                        console.error('Error processing data from Firebase:', err);
                        console.error('Error stack:', err.stack);
                    }
                }, (error) => {
                    console.error('=== Firebase realtime listener error ===');
                    console.error('Error code:', error.code);
                    console.error('Error message:', error.message);
                    console.error('Error details:', error);
                });
            } catch (err) {
                console.error('Error setting up realtime sync:', err);
                console.error('Error stack:', err.stack);
            }
        }

        function saveFirebaseConfig() {
            const apiKey = document.getElementById('firebase-api-key').value.trim();
            const projectId = document.getElementById('firebase-project-id').value.trim();
            const databaseURL = document.getElementById('firebase-database-url').value.trim();
            
            if (!apiKey || !projectId || !databaseURL) {
                showToast('Semua field harus diisi!');
                return;
            }
            
            console.log('=== Saving Firebase Config ===');
            console.log('Project ID:', projectId);
            console.log('Database URL:', databaseURL);
            
            firebaseConfig = {
                apiKey,
                projectId,
                databaseURL,
                authDomain: `${projectId}.firebaseapp.com`,
                storageBucket: `${projectId}.appspot.com`
            };
            
            localStorage.setItem('pbjt-firebase-config', JSON.stringify(firebaseConfig));
            
            updateSyncStatus('üü°', 'Menghubungkan...', 'Menyambungkan ke Firebase');
            
            // Load Firebase scripts and reinitialize
            try {
                // If firebase app already exists, delete it to avoid conflicts
                if (window.firebase && window.firebase.apps && window.firebase.apps.length > 0) {
                    console.log('Deleting existing Firebase app...');
                    window.firebase.apps.forEach(app => app.delete());
                }
                
                // Load Firebase scripts
                loadFirebaseScripts();
                
                showToast('Konfigurasi disimpan! Memuat Firebase...');
            } catch (err) {
                console.error('Error reinitializing Firebase:', err);
                showToast('Konfigurasi disimpan, tapi gagal memuat Firebase.');
            }
        }

        function loadFirebaseConfig() {
            try {
                if (firebaseConfig) {
                    const apiKeyInput = document.getElementById('firebase-api-key');
                    const projectIdInput = document.getElementById('firebase-project-id');
                    const databaseUrlInput = document.getElementById('firebase-database-url');
                    
                    if (apiKeyInput) apiKeyInput.value = firebaseConfig.apiKey || '';
                    if (projectIdInput) projectIdInput.value = firebaseConfig.projectId || '';
                    if (databaseUrlInput) databaseUrlInput.value = firebaseConfig.databaseURL || '';
                }
                loadSyncSettings();
                updateFirebaseStatus();
                
                // Ensure admin can see setting menu
                if (currentUser && currentUser.role === 'admin') {
                    const navSetting = document.getElementById('nav-setting');
                    if (navSetting) {
                        navSetting.classList.remove('hidden');
                        console.log('Setting menu shown for admin in loadFirebaseConfig');
                    }
                }
                
                // Force check FAB visibility after Firebase config is loaded
                setTimeout(() => {
                    const fabBtn = document.getElementById('fab-btn');
                    const currentSection = document.querySelector('.nav-btn.active')?.dataset.section;
                    const kartuInfo = document.getElementById('kartu-info');
                    
                    console.log('=== Force checking FAB after Firebase config loaded ===');
                    console.log('Current section:', currentSection);
                    console.log('Has kartu info visible:', kartuInfo && !kartuInfo.classList.contains('hidden'));
                    
                    // Show FAB if in kartu section and kartu info is visible
                    if (fabBtn && currentSection === 'kartu' && kartuInfo && !kartuInfo.classList.contains('hidden')) {
                        fabBtn.classList.remove('hidden');
                        console.log('FAB button force shown after Firebase config');
                    }
                }, 300);
                
            } catch (error) {
                console.error('Error loading firebase config:', error);
                // Don't block the app if config loading fails
            }
        }

        function clearFirebaseConfig() {
            if (!confirm('Hapus konfigurasi Firebase?')) return;
            
            firebaseConfig = null;
            localStorage.removeItem('pbjt-firebase-config');
            isConnected = false;
            
            document.getElementById('firebase-api-key').value = '';
            document.getElementById('firebase-project-id').value = '';
            document.getElementById('firebase-database-url').value = '';
            
            updateSyncStatus('üîµ', 'Tidak Terhubung', 'Firebase tidak dikonfigurasi');
            updateFirebaseStatus();
            
            showToast('Konfigurasi dihapus!');
        }

        function updateFirebaseStatus() {
            try {
                const el = document.getElementById('firebase-status');
                if (!el) {
                    console.log('firebase-status element not found');
                    return;
                }
                if (isConnected && db) {
                    el.textContent = 'üü¢ Terhubung ke Firebase';
                    el.className = 'mb-3 px-3 py-2 rounded-lg text-sm bg-green-100 text-green-700';
                } else {
                    el.textContent = 'üîµ Belum diatur';
                    el.className = 'mb-3 px-3 py-2 rounded-lg text-sm bg-gray-100 text-gray-600';
                }
            } catch (error) {
                console.error('Error updating firebase status:', error);
            }
        }

        function loadSyncSettings() {
            document.getElementById('auto-sync-toggle').checked = autoSyncEnabled;
            document.getElementById('sync-on-online-toggle').checked = syncOnOnlineEnabled;
            updateLastSyncTime();
        }

        function toggleAutoSync() {
            autoSyncEnabled = document.getElementById('auto-sync-toggle').checked;
            localStorage.setItem('pbjt-auto-sync', autoSyncEnabled);
            
            if (autoSyncEnabled && isConnected) {
                showToast('Sinkronisasi otomatis diaktifkan');
                manualSync();
            } else {
                showToast('Sinkronisasi otomatis dinonaktifkan');
            }
        }

        function toggleSyncOnOnline() {
            syncOnOnlineEnabled = document.getElementById('sync-on-online-toggle').checked;
            localStorage.setItem('pbjt-sync-on-online', syncOnOnlineEnabled);
            
            if (syncOnOnlineEnabled) {
                showToast('Sinkron saat online diaktifkan');
            } else {
                showToast('Sinkron saat online dinonaktifkan');
            }
        }

        function updateLastSyncTime() {
            const container = document.getElementById('last-sync-container');
            const timeEl = document.getElementById('last-sync-time');
            
            if (lastSyncTime) {
                const date = new Date(lastSyncTime);
                timeEl.textContent = date.toLocaleString('id-ID');
                container.classList.remove('hidden');
            } else {
                container.classList.add('hidden');
            }
        }

        function manualSync() {
            if (!isConnected || !db) {
                console.log('=== manualSync: Firebase not connected ===');
                showToast('Firebase belum terhubung!');
                return;
            }
            
            if (syncInProgress) {
                console.log('=== manualSync: Sync already in progress ===');
                showToast('Sinkronisasi sedang berjalan...');
                return;
            }
            
            syncInProgress = true;
            updateSyncStatus('üü°', 'Sinkronisasi...', 'Mengunggah data ke Firebase');
            
            const data = { wajibPajak, petugas, kartuKontrol, settings };
            
            console.log('=== Starting PUSH to Firebase (SYNC) ===');
            console.log('Data to push:', {
                wajibPajak: wajibPajak.length + ' items',
                petugas: petugas.length + ' items',
                kartuKontrol: kartuKontrol.length + ' items',
                settings: '1 object'
            });
            
            try {
                // Cek apakah db.ref() bisa dipanggil
                const ref = db.ref('/');
                if (!ref) {
                    throw new Error('Firebase reference is undefined');
                }
                
                ref.set(data)
                    .then(() => {
                        lastSyncTime = new Date().toISOString();
                        localStorage.setItem('pbjt-last-sync', lastSyncTime);
                        updateLastSyncTime();
                        
                        updateSyncStatus('üü¢', 'Sinkronisasi Berhasil', `Terakhir: ${new Date(lastSyncTime).toLocaleTimeString('id-ID')}`);
                        
                        syncInProgress = false;
                        showToast('Sinkronisasi berhasil! ‚úÖ');
                        console.log('=== Push to Firebase SUCCESS ===');
                        console.log('Manual sync completed at', lastSyncTime);
                    })
                    .catch(err => {
                        syncInProgress = false;
                        const msg = err.code === 'PERMISSION_DENIED' ? 'Izin ditolak - Cek database rules' : err.message;
                        
                        updateSyncStatus('üî¥', 'Sinkronisasi Gagal', msg);
                        showToast('Sinkronisasi gagal: ' + msg);
                        console.error('=== Push to Firebase FAILED ===');
                        console.error('Error code:', err.code);
                        console.error('Error message:', err.message);
                        console.error('Error details:', err);
                    });
            } catch (error) {
                syncInProgress = false;
                console.error('=== manualSync ERROR ===');
                console.error('Error:', error.message);
                updateSyncStatus('üî¥', 'Sinkronisasi Gagal', error.message);
                showToast('Sinkronisasi gagal: ' + error.message);
            }
        }

        function testConnection() {
            if (!isConnected || !db) {
                showToast('Firebase belum terhubung!');
                return;
            }
            
            updateSyncStatus('üü°', 'Menguji Koneksi...', 'Mengirim data tes');
            
            db.ref('/testConnection').set({ timestamp: Date.now() })
                .then(() => db.ref('/testConnection').remove())
                .then(() => {
                    updateSyncStatus('üü¢', 'Koneksi Berhasil', 'Firebase dapat diakses');
                    showToast('Koneksi Firebase berhasil! üéâ');
                })
                .catch(err => {
                    const msg = err.code === 'PERMISSION_DENIED' ? 'Izin ditolak - Cek database rules' : err.message;
                    updateSyncStatus('üî¥', 'Koneksi Gagal', msg);
                    showToast('Koneksi gagal: ' + msg);
                });
        }

        // Auto sync functions
        function autoSyncWP() {
            console.log('=== autoSyncWP START ===');
            console.log('autoSyncEnabled:', autoSyncEnabled);
            console.log('isConnected:', isConnected);
            console.log('db exists:', !!db);
            console.log('db.ref exists:', db && typeof db.ref === 'function');
            console.log('syncInProgress:', syncInProgress);
            
            if (autoSyncEnabled && isConnected && db && !syncInProgress) {
                try {
                    if (typeof db.ref !== 'function') {
                        console.log('Auto-sync wajibPajak SKIPPED: db.ref is not a function');
                        return;
                    }
                    const ref = db.ref('/wajibPajak');
                    if (ref) {
                        console.log('Auto-sync: Pushing wajibPajak to Firebase...');
                        ref.set(wajibPajak)
                            .then(() => console.log('Auto-sync wajibPajak SUCCESS'))
                            .catch(e => console.log('Auto-sync wajibPajak FAILED:', e));
                    } else {
                        console.log('Auto-sync wajibPajak SKIPPED: ref is undefined');
                    }
                } catch (err) {
                    console.log('Auto-sync wajibPajak ERROR:', err);
                }
            } else {
                console.log('Auto-sync wajibPajak SKIPPED');
            }
        }

        function autoSyncPetugas() {
            console.log('=== autoSyncPetugas START ===');
            console.log('autoSyncEnabled:', autoSyncEnabled);
            console.log('isConnected:', isConnected);
            console.log('db exists:', !!db);
            console.log('db.ref exists:', db && typeof db.ref === 'function');
            console.log('syncInProgress:', syncInProgress);
            
            if (autoSyncEnabled && isConnected && db && !syncInProgress) {
                try {
                    if (typeof db.ref !== 'function') {
                        console.log('Auto-sync petugas SKIPPED: db.ref is not a function');
                        return;
                    }
                    const ref = db.ref('/petugas');
                    if (ref) {
                        console.log('Auto-sync: Pushing petugas to Firebase...');
                        ref.set(petugas)
                            .then(() => console.log('Auto-sync petugas SUCCESS'))
                            .catch(e => console.log('Auto-sync petugas FAILED:', e));
                    } else {
                        console.log('Auto-sync petugas SKIPPED: ref is undefined');
                    }
                } catch (err) {
                    console.log('Auto-sync petugas ERROR:', err);
                }
            } else {
                console.log('Auto-sync petugas SKIPPED');
            }
        }

        function autoSyncKartu() {
            console.log('=== autoSyncKartu START ===');
            console.log('autoSyncEnabled:', autoSyncEnabled);
            console.log('isConnected:', isConnected);
            console.log('db exists:', !!db);
            console.log('db.ref exists:', db && typeof db.ref === 'function');
            console.log('syncInProgress:', syncInProgress);
            
            if (autoSyncEnabled && isConnected && db && !syncInProgress) {
                try {
                    if (typeof db.ref !== 'function') {
                        console.log('Auto-sync kartuKontrol SKIPPED: db.ref is not a function');
                        return;
                    }
                    const ref = db.ref('/kartuKontrol');
                    if (ref) {
                        console.log('Auto-sync: Pushing kartuKontrol to Firebase...');
                        ref.set(kartuKontrol)
                            .then(() => console.log('Auto-sync kartuKontrol SUCCESS'))
                            .catch(e => console.log('Auto-sync kartuKontrol FAILED:', e));
                    } else {
                        console.log('Auto-sync kartuKontrol SKIPPED: ref is undefined');
                    }
                } catch (err) {
                    console.log('Auto-sync kartuKontrol ERROR:', err);
                }
            } else {
                console.log('Auto-sync kartuKontrol SKIPPED');
            }
        }

        // ==================== ONLINE/OFFLINE STATUS ====================
        function updateOnlineStatus() {
            showOnlineStatus();
            
            if (navigator.onLine && syncOnOnlineEnabled && isConnected && db) {
                console.log('Device came online, triggering sync...');
                setTimeout(() => manualSync(), 2000);
            }
        }

        function showOnlineStatus() {
            const el = document.getElementById('online-status');
            const iconEl = document.getElementById('sync-icon');
            const statusEl = document.getElementById('sync-status-text');
            const detailEl = document.getElementById('sync-detail-text');
            
            if (navigator.onLine) {
                if (isConnected && db) {
                    iconEl.innerHTML = '<i class="ri-cloud-line online-badge text-green-600"></i>';
                    statusEl.textContent = 'üü¢ Terhubung ke Firebase';
                    detailEl.textContent = 'Data tersinkronisasi secara otomatis';
                    el.className = 'm-4 px-4 py-3 rounded-lg flex items-center gap-3 bg-green-50 border border-green-200';
                } else {
                    iconEl.innerHTML = '<i class="ri-cloud-off-line text-gray-500"></i>';
                    statusEl.textContent = 'üîµ Offline Mode';
                    detailEl.textContent = 'Data tersimpan lokal';
                    el.className = 'm-4 px-4 py-3 rounded-lg flex items-center gap-3 bg-gray-100 border border-gray-200';
                }
            } else {
                iconEl.innerHTML = '<i class="ri-wifi-off-line text-red-500"></i>';
                statusEl.textContent = 'üî¥ Tidak Ada Internet';
                detailEl.textContent = 'Data tersimpan lokal, akan sinkron saat online';
                el.className = 'm-4 px-4 py-3 rounded-lg flex items-center gap-3 bg-red-50 border border-red-200';
            }
            
            el.classList.remove('hidden');
        }

        function updateSyncStatus(icon, status, detail) {
            const iconEl = document.getElementById('sync-icon');
            const statusEl = document.getElementById('sync-status-text');
            const detailEl = document.getElementById('sync-detail-text');
            
            if (iconEl) iconEl.innerHTML = icon.includes('üü¢') ? '<i class="ri-cloud-check-line text-green-600"></i>' :
                                          icon.includes('üî¥') ? '<i class="ri-error-warning-line text-red-600"></i>' :
                                          icon.includes('üü°') ? '<i class="ri-loader-4-line text-yellow-600 animate-spin"></i>' :
                                          '<i class="ri-cloud-line text-gray-500"></i>';
            if (statusEl) statusEl.textContent = status;
            if (detailEl) detailEl.textContent = detail;
        }

        // ==================== RENDER ALL ====================
        function renderAll() {
            renderWP();
            renderPetugas();
            updateStats();
            renderChart();
            updateTunggakanBadge();
        }

        // ==================== FORMAT FUNCTIONS ====================
        function formatRupiah(num) { return 'Rp ' + num.toLocaleString('id-ID'); }
        function formatRupiahCompact(num) { return num >= 1000000 ? (num/1000000).toFixed(1) + ' Jt' : num >= 1000 ? (num/1000).toFixed(1) + ' Rb' : 'Rp ' + num.toLocaleString('id-ID'); }
        function formatDate(str) { return new Date(str).toLocaleDateString('id-ID', { day: 'numeric', month: 'short', year: 'numeric' }); }
        function showToast(msg) { 
            const t = document.getElementById('toast'); 
            t.textContent = msg; 
            t.classList.remove('hidden'); 
            setTimeout(() => t.classList.add('hidden'), 2000); 
        }
        function addSampleData() {
            wajibPajak = [
                { id: '1', npwpd: '01.123.456.789-001', nama: 'Restoran Sederhana', pemilik: 'Budi', alamat: 'Jl. Merdeka No. 10', tarif: 10 },
                { id: '2', npwpd: '01.123.456.789-002', nama: 'Kafe Senja', pemilik: 'Siti', alamat: 'Jl. Sudirman No. 25', tarif: 10 }
            ];
            localStorage.setItem('pbjt-wp', JSON.stringify(wajibPajak));
        }

        // ==================== DEBUG FUNCTIONS ====================
        window.testWPForm = function() {
            console.log('=== Test WP Form ===');
            document.getElementById('wp-id').value = '';
            document.getElementById('wp-npwpd').value = 'TEST.123.456';
            document.getElementById('wp-nama').value = 'Test Restoran';
            document.getElementById('wp-pemilik').value = 'Test Owner';
            document.getElementById('wp-alamat').value = 'Test Address';
            document.getElementById('wp-tarif').value = '10';
            saveWP();
        };

        window.debugForms = function() {
            console.log('=== Debug Forms ===');
            console.log('Wajib Pajak count:', wajibPajak.length);
            console.log('Petugas count:', petugas.length);
            console.log('saveWP function:', typeof saveWP);
            console.log('savePetugas function:', typeof savePetugas);
        };
    </script>
</body>
</html>
